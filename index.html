<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSCCE Hospital Checklist v1.6.3 — Login + Local Save</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat SDKs (Auth + allowlist read only) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --sticky-offset: 120px; }
    .screen-only { display: block; }
    .print-only { display: none; }
    @media print {
      .screen-only { display: none !important; }
      .print-only { display: none; }
      body.print-full #sheet-full.print-only { display: block !important; }
      body.print-noncomp #sheet-noncomp.print-only { display: block !important; }
      body { background: #fff !important; }
    }
    .section-body { padding-top: 1rem; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="screen-only"></div>
  <div id="print-mount">
    <div id="sheet-full" class="print-only"></div>
    <div id="sheet-noncomp" class="print-only"></div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Firebase setup
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDKSvo5KNuXPq83284_6GOnxXisKA_lSks",
      authDomain: "kssce-51e3e.firebaseapp.com",
      projectId: "kssce-51e3e",
      storageBucket: "kssce-51e3e.appspot.com",
      messagingSenderId: "308291560377",
      appId: "1:308291560377:web:ae634dd42e9ac1459e0c68"
    };
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const auth = () => firebase.auth();
    const db   = () => firebase.firestore();

    async function isAllowlisted(email){
      if (!email) return false;
      try {
        const doc = await db().doc(`allowlist/${String(email).trim().toLowerCase()}`).get();
        return doc.exists;
      } catch { return false; }
    }

    const YNN = ["Yes","No","N/A"];
    const SECTIONS = [
      { code: "A", title: "General", items: [
        { id: "ic-measures", text: "Hospital adopts infection control measures" },
        { id: "bmw", text: "Appropriate biomedical waste management in place" }
      ]},
      { code: "B", title: "OPD", items: [
        { id: "opd-basics", text: "Stethoscope, torch, thermometer, BP apparatus, handwash" },
        { id: "female-attendant", text: "Female attendant for female patients; privacy ensured" }
      ]}
    ];
    const ANNEXURE_SECTIONS = [
      { code: "Annx1", title: "Annexure 1 – Furniture", items: [
        { id: "a1-0", text: "Examination table" },
        { id: "a1-1", text: "Writing table" }
      ]}
    ];

    function nowStr(){ return new Date().toLocaleString(); }

    function HeaderFields({ value, onChange }){
      return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white p-4 rounded-2xl border">
          <div><label>Hospital</label><input value={value.hospital||""} onChange={e=>onChange({...value,hospital:e.target.value})} className="w-full border px-2 py-1"/></div>
          <div><label>Address</label><input value={value.address||""} onChange={e=>onChange({...value,address:e.target.value})} className="w-full border px-2 py-1"/></div>
          <div><label>Date(s)</label><input value={value.visitDates||""} onChange={e=>onChange({...value,visitDates:e.target.value})} className="w-full border px-2 py-1"/></div>
          <div><label>Assessor</label><input value={value.assessor||""} onChange={e=>onChange({...value,assessor:e.target.value})} className="w-full border px-2 py-1"/></div>
        </div>
      );
    }

    function SectionCard({ section, state, setState }){
      return (
        <div className="rounded-2xl border bg-white shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-slate-50 border-b sticky z-20" style={{ top: 'var(--sticky-offset)' }}>
            <div className="font-semibold">{section.code}. {section.title}</div>
          </div>
          <div className="divide-y section-body pt-3">
            {section.items.map((it,idx)=>{
              const key=`${section.code}-${it.id}`;
              const row=state[key]||{v:"",note:""};
              return (
                <div key={key} className="p-4 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                  <div className="md:col-span-7">{idx+1}. {it.text}</div>
                  <div className="md:col-span-2"><select value={row.v} onChange={e=>setState(s=>({...s,[key]:{...s[key],v:e.target.value}}))} className="w-full border px-2 py-1"><option value="">Select</option>{YNN.map(x=><option key={x}>{x}</option>)}</select></div>
                  <div className="md:col-span-3"><input value={row.note||""} onChange={e=>setState(s=>({...s,[key]:{...s[key],note:e.target.value}}))} className="w-full border px-2 py-1" placeholder="Notes"/></div>
                </div>
              )
            })}
          </div>
        </div>
      );
    }

    function MetaTable({ meta }){
      return (
        <table className="w-full text-sm border mt-2">
          <tbody>
            <tr><td className="border px-2 py-1">Hospital</td><td className="border px-2 py-1">{meta.hospital}</td></tr>
            <tr><td className="border px-2 py-1">Address</td><td className="border px-2 py-1">{meta.address}</td></tr>
            <tr><td className="border px-2 py-1">Date(s)</td><td className="border px-2 py-1">{meta.visitDates}</td></tr>
            <tr><td className="border px-2 py-1">Assessor</td><td className="border px-2 py-1">{meta.assessor}</td></tr>
          </tbody>
        </table>
      );
    }

    function FooterStamp({ when }){
      return (<div className="mt-6 text-xs text-slate-600">© KSCCE. Designed by Nitin. Generated: {when}</div>);
    }

    function FullReport({ meta, answers }){
      return (
        <div className="p-6 text-slate-900">
          <h1 className="text-xl font-semibold mb-1">KSCCE Hospital Checklist – Full Report</h1>
          <MetaTable meta={meta} />
          {[...SECTIONS,...ANNEXURE_SECTIONS].map(s=>(
            <div key={s.code} className="mt-4">
              <h2 className="font-semibold mb-2">{s.code}. {s.title}</h2>
              <table className="w-full text-sm border">
                <tbody>
                  {s.items.map((it,idx)=>{
                    const key=`${s.code}-${it.id}`; const row=answers[key]||{};
                    return (<tr key={key}><td className="border px-2 py-1">{idx+1}. {it.text}</td><td className="border px-2 py-1">{row.v||""}</td><td className="border px-2 py-1">{row.note||""}</td></tr>)
                  })}
                </tbody>
              </table>
            </div>
          ))}
          <FooterStamp when={nowStr()} />
        </div>
      );
    }

    function NonCompReport({ meta, answers }){
      const rows=[];
      for(const s of [...SECTIONS,...ANNEXURE_SECTIONS]) for(const it of s.items){ const key=`${s.code}-${it.id}`; if(answers[key]?.v==="No") rows.push({section:s.code,item:it.text,note:answers[key]?.note||""}); }
      return (
        <div className="p-6 text-slate-900">
          <h1 className="text-xl font-semibold mb-1">Non‑Compliance Report</h1>
          <MetaTable meta={meta} />
          {rows.length?(
            <table className="w-full text-sm border mt-3"><tbody>{rows.map((r,i)=>(<tr key={i}><td className="border px-2 py-1">{r.section}</td><td className="border px-2 py-1">{r.item}</td><td className="border px-2 py-1">{r.note}</td></tr>))}</tbody></table>
          ):(<p>No items marked as No.</p>)}
          <FooterStamp when={nowStr()} />
        </div>
      );
    }

    function AuthScreen(){
      const [tab,setTab]=useState("login"); const [email,setEmail]=useState(""); const [password,setPassword]=useState(""); const [error,setError]=useState(null);
      async function handleLogin(e){ e.preventDefault(); setError(null); try{ if(!(await isAllowlisted(email))) throw new Error("Not allowlisted"); await auth().signInWithEmailAndPassword(email,password);}catch(err){ setError(err.message);} }
      async function handleSignup(e){ e.preventDefault(); setError(null); try{ if(!(await isAllowlisted(email))) throw new Error("Not allowlisted"); await auth().createUserWithEmailAndPassword(email,password);}catch(err){ setError(err.message);} }
      return (
        <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
          <div className="max-w-md w-full bg-white rounded-xl shadow p-6 space-y-4">
            <h1 className="font-semibold text-lg">KSCCE Assessor Portal</h1>
            <div className="flex gap-2"><button onClick={()=>setTab("login")} className={`px-3 py-1 rounded ${tab==="login"?"bg-teal-600 text-white":"bg-slate-200"}`}>Login</button><button onClick={()=>setTab("signup")} className={`px-3 py-1 rounded ${tab==="signup"?"bg-teal-600 text-white":"bg-slate-200"}`}>Signup</button></div>
            <form onSubmit={tab==="login"?handleLogin:handleSignup} className="space-y-3">
              <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full border px-2 py-1"/>
              <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Password" className="w-full border px-2 py-1"/>
              {error&&<div className="text-red-600 text-sm">{error}</div>}
              <button type="submit" className="w-full bg-teal-600 text-white py-1 rounded">{tab==="login"?"Login":"Create Account"}</button>
            </form>
          </div>
        </div>
      );
    }

    function ChecklistApp({ userEmail }){
      const [meta,setMeta]=useState({hospital:"",address:"",visitDates:"",assessor:""});
      const [answers,setAnswers]=useState({});
      const [tab,setTab]=useState("Checklist");
      const fileInputRef=useRef(null);
      const nonCompliances=useMemo(()=>{const out=[];for(const s of [...SECTIONS,...ANNEXURE_SECTIONS])for(const it of s.items){const k=`${s.code}-${it.id}`;if(answers[k]?.v==="No")out.push({section:s.code,item:it.text,note:answers[k]?.note||""});}return out;},[answers]);
      function saveLocal(){const data=JSON.stringify({meta,answers},null,2);const blob=new Blob([data],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="checklist.json";a.click();}
      function loadLocal(e){const file=e.target.files?.[0];if(!file)return;const r=new FileReader();r.onload=()=>{try{const j=JSON.parse(r.result);setMeta(j.meta||{});setAnswers(j.answers||{});}catch{alert("Invalid file");}};r.readAsText(file);}
      function newAssessment(){if(confirm("Start new assessment?")){setMeta({hospital:"",address:"",visitDates:"",assessor:""});setAnswers({});}}
      function printFull(){const mount=document.getElementById("sheet-full");ReactDOM.render(<FullReport meta={meta} answers={answers}/>,mount);document.body.classList.add("print-full");setTimeout(()=>{window.print();document.body.classList.remove("print-full");mount.innerHTML="";},50);}
      function printNonComp(){const mount=document.getElementById("sheet-noncomp");ReactDOM.render(<NonCompReport meta={meta} answers={answers}/>,mount);document.body.classList.add("print-noncomp");setTimeout(()=>{window.print();document.body.classList.remove("print-noncomp");mount.innerHTML="";},50);}
      return (
        <>
          <header className="sticky top-0 z-30 bg-white border-b px-4 py-2 flex justify-between">
            <div><strong>KSCCE Checklist</strong> — {userEmail}</div>
            <div className="flex gap-2"><button onClick={()=>auth().signOut()} className="px-2 border">Sign out</button></div>
          </header>
          <main className="max-w-5xl mx-auto p-4 space-y-4">
            <div className="flex flex-wrap gap-2 mb-4"><button onClick={printFull} className="px-3 py-1 bg-slate-800 text-white rounded">Export Edited Items (PDF)</button><button onClick={printNonComp} className="px-3 py-1 bg-teal-600 text-white rounded">Export Non-Compliances (PDF)</button><button onClick={saveLocal} className="px-3 py-1 border rounded">Save As (Local)</button><button onClick={()=>fileInputRef.current.click()} className="px-3 py-1 border rounded">Load from File</button><button onClick={newAssessment} className="px-3 py-1 border rounded">New Assessment</button></div>
            <HeaderFields value={meta} onChange={setMeta}/>
            <div className="space-y-6">{(tab==="Checklist"?SECTIONS:ANNEXURE_SECTIONS.filter(x=>x.code===tab)).map(s=><SectionCard key={s.code} section={s} state={answers} setState={setAnswers}/>)}</div>
            <div className="border p-3 bg-white rounded"><h3 className="font-semibold">Non‑Compliance Summary</h3>{nonCompliances.length?(<ul className="list-disc pl-5">{nonCompliances.map((r,i)=><li key={i}>{r.section}: {r.item} — {r.note}</li>)}</ul>):(<p>No items marked as No</p>)}</div>
            <input type="file" ref={fileInputRef} accept="application/json" onChange={loadLocal} className="hidden"/>
          </main>
          <footer className="text-xs text-center py-4 border-t">© KSCCE. Designed by Nitin.</footer>
        </>
      );
    }

    function App(){
      const [state,setState]=useState({loading:true,user:null,allowed:false});
      useEffect(()=>{return auth().onAuthStateChanged(async (user)=>{if(!user){setState({loading:false,user:null,allowed:false});}else{const ok=await isAllowlisted(user.email||"");if(!ok){await auth().signOut();setState({loading:false,user:null,allowed:false});}else{setState({loading:false,user,allowed:true});}}});},[]);
      if(state.loading) return <div className="p-10">Loading…</div>;
      if(!state.user||!state.allowed) return <AuthScreen/>;
      return <ChecklistApp userEmail={state.user.email}/>;
    }
    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>