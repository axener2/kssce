<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSCCE Hospital Checklist v2.2.3 — Live Collaboration</title>

  <!-- Tailwind for UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (dev preview) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .screen-only { display: block; }
    .print-only  { display: none; }
    @media print {
      .screen-only { display: none !important; }
      .print-only  { display: block !important; }
      body { background: #fff !important; }
    }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="screen-only"></div>
  <div id="sheet-full" class="print-only"></div>
  <div id="sheet-noncomp" class="print-only"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const VERSION = "v2.2.3";
    const INVITES_COLL = "collabInvites";
    const ASSESS_COLL  = "assessments";
    const PRESENCE_COLL= "presence";
    const TYPING_IDLE_MS = 1200;
    const PRESENCE_HEARTBEAT_MS = 20000; // 20s
    const PRESENCE_STALE_MS = 60000;     // 60s
    const WRITE_DEBOUNCE_MS = 400;       // keystroke batching

    // ---------------- Firebase ----------------
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDKSvo5KNuXPq83284_6GOnxXisKA_lSks",
      authDomain: "kssce-51e3e.firebaseapp.com",
      projectId: "kssce-51e3e",
      storageBucket: "kssce-51e3e.appspot.com",
      messagingSenderId: "308291560377",
      appId: "1:308291560377:web:ae634dd42e9ac1459e0c68"
    };
    try { if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG); } catch(e) { console.warn(e); }
    const auth = () => firebase.auth();
    const db   = () => firebase.firestore();

    async function isAllowlisted(email){
      if (!email) return false;
      try {
        const doc = await db().doc('allowlist/' + String(email).trim().toLowerCase()).get();
        return doc.exists;
      } catch (err) { console.warn("Allowlist check failed:", err); return false; }
    }

    // Helpers
    const safeId = (email) => encodeURIComponent(String(email||"").toLowerCase());
    const initials = (email) => (String(email||"?").trim()[0]||"?").toUpperCase();

    // ---------------- Data ----------------
    const YNN = ["Yes","No","N/A"];
    const SECTIONS = [
      { code: "A", title: "General", items: [
        { id: "ic-measures", text: "Hospital should adopt infection control measures." },
        { id: "bmw", text: "Appropriate arrangements for Bio-Medical Waste (BMW) management should be in place." },
        { id: "med-records", text: "Medical Records should be maintained by either in hard or soft copy." },
        { id: "lab-services", text: "Laboratory Services should be available. The same could be dedicated set up or a collection centre with appropriate arrangements for forwarding samples and specimens as well as effective deliverance of results." },
        { id: "birth-death", text: "Birth and death information register should be maintained." },
        { id: "power-backup", text: "Back up facility for electricity failure which covers essential activities should be available." },
        { id: "fire-ext", text: "Fire extinguishers should be available." },
        { id: "linen", text: "Facility for clean/ sterilized linens should be available." },
        { id: "ambulance", text: "Ambulance service arrangement should be in place." },
        { id: "display-services", text: "Display of Services provided and Rates & Packages." },
        { id: "charges-info", text: "Information regarding the services and their approximate charges should be provided by the administration of the hospital." }
      ]},
      { code: "B", title: "OPD", items: [
        { id: "opd-basics", text: "Availability of stethoscope, Torch, Thermometer (Preferably non-mercury), BP Apparatus (Preferably non-mercury), Hand wash facility, Examination table, chairs or stools for the doctor, patient and bystander." },
        { id: "female-attendant", text: "Female attendant for female patients, Privacy to Patients, Information Material for Patients." },
        { id: "registration", text: "Registration of Patients: Name, Age, Sex and contact details (at least mobile number) of the patient should be entered and available in hard or softcopy." },
        { id: "waiting-amenities", text: "Waiting Area, Drinking Water facility and separate male & female toilets should be available." },
        { id: "doc-display", text: "The names of the doctors with their qualifications should be displayed." }
      ]},
      { code: "C", title: "Casualty / Emergency", items: [
        { id: "cas-hr", text: "Human resources supporting the casualty services should be available during the working hours." },
        { id: "cas-drugs-eq", text: "Emergency drugs and equipments should be available according to the scope of the services." },
        { id: "cas-signage", text: "Signage board of the casualty should be displayed at the entrance and be easily visible." },
        { id: "ramp", text: "Patient friendly ramp or slope facility should be available." },
        { id: "stretchers", text: "Stretchers/wheel chairs should be available." }
      ]},
      // more sections come in Part 2
    ];

    // ---------------- More Sections ----------------
    SECTIONS.push(
      { code: "D", title: "Indoor (IP)", items: [
        { id: "ip-infra", text: "Basic infrastructure for inpatients should be available with adequate beds." },
        { id: "ip-nursing", text: "Nursing care should be available as per the patient requirement." },
        { id: "ip-drugs", text: "Emergency drugs should be available in the ward." },
        { id: "ip-records", text: "Inpatient records should be maintained." }
      ]},
      { code: "E", title: "OT / Procedures", items: [
        { id: "ot-asepsis", text: "Operation theatre should be clean and aseptic." },
        { id: "ot-sterilization", text: "Sterilization protocols should be followed." },
        { id: "ot-instruments", text: "Essential instruments should be available and functional." }
      ]},
      { code: "F", title: "ICU / Critical Care", items: [
        { id: "icu-staff", text: "Trained staff should be available for ICU services." },
        { id: "icu-equip", text: "Critical care equipment should be maintained in working condition." }
      ]},
      { code: "G", title: "Maternity / OBG", items: [
        { id: "obg-labour", text: "Labour room should be adequately equipped." },
        { id: "obg-nicu", text: "Newborn corner/NICU arrangements should be available as per scope." }
      ]},
      { code: "H", title: "Pediatrics", items: [
        { id: "ped-staff", text: "Qualified pediatric staff should be available." },
        { id: "ped-drugs", text: "Pediatric emergency drugs should be available." }
      ]},
      { code: "I", title: "Pharmacy", items: [
        { id: "pharmacy-license", text: "Pharmacy should be licensed." },
        { id: "pharmacy-drugs", text: "Storage and dispensing of drugs should be satisfactory." }
      ]},
      { code: "J", title: "Laboratory", items: [
        { id: "lab-quality", text: "Lab should follow quality and safety protocols." },
        { id: "lab-outsource", text: "Outsourced labs should have proper agreements in place." }
      ]},
      { code: "K", title: "Radiology", items: [
        { id: "radio-license", text: "License should be available for radiology equipment as applicable." },
        { id: "radio-safety", text: "Radiation safety measures should be followed." }
      ]},
      { code: "L", title: "Blood Bank / Storage", items: [
        { id: "blood-license", text: "Blood storage should comply with licensing norms." }
      ]},
      { code: "M", title: "Support Services", items: [
        { id: "support-laundry", text: "Laundry services should be available." },
        { id: "support-kitchen", text: "Kitchen services (if available) should be hygienic." }
      ]},
      { code: "N", title: "Waste Management", items: [
        { id: "waste-segregation", text: "Segregation of waste at source should be ensured." },
        { id: "waste-disposal", text: "Waste disposal should follow protocols." }
      ]},
      { code: "O", title: "Records & Legal", items: [
        { id: "records-consent", text: "Informed consent should be taken where applicable." },
        { id: "records-legal", text: "Legal and statutory records should be maintained." }
      ]},
      { code: "P", title: "Other Services", items: [
        { id: "others-insurance", text: "Insurance desk / TPA desk (if applicable)." },
        { id: "others-helpdesk", text: "Helpdesk services should be available." }
      ]}
    );

    // ---------------- Annexures ----------------
    const ANNEXURES = [
      { code: "Annx1", title: "Human Resources", items: [
        { id: "hr-doctors", text: "List of Doctors with qualifications." },
        { id: "hr-nurses", text: "List of Nurses with qualifications." }
      ]},
      { code: "Annx2", title: "Equipment", items: [
        { id: "eq-basic", text: "List of basic equipment available." }
      ]},
      { code: "Annx3", title: "Registers", items: [
        { id: "reg-birth", text: "Birth Register." },
        { id: "reg-death", text: "Death Register." }
      ]},
      { code: "Annx4", title: "Other", items: [
        { id: "other-license", text: "Copy of statutory licenses." }
      ]}
    ];

    // ---------------- UI: Assessors ----------------
    function HeaderFields({ value, onChange, onMetaChange }){
      const assessors = Array.isArray(value.assessors) && value.assessors.length
        ? value.assessors
        : [{ name: value.assessor || "", role: value.assessorRole || "" }];

      function setAssessors(next){
        const first = next[0] || { name: "", role: "" };
        const updated = { ...value, assessors: next, assessor: first.name || "", assessorRole: first.role || "" };
        onChange(updated);
        onMetaChange && onMetaChange(updated);
      }
      function updateAssessor(idx, field, val){
        const next = assessors.map((a,i)=> i===idx ? { ...a, [field]: val } : a);
        setAssessors(next);
      }
      function addAssessor(){ setAssessors([...assessors, { name: "", role: "" }]); }
      function removeAssessor(idx){
        const next = assessors.filter((_,i)=>i!==idx);
        setAssessors(next.length ? next : [{ name:"", role:"" }]);
      }

      const wrapMeta = (patch) => {
        const m = { ...value, ...patch };
        onChange(m);
        onMetaChange && onMetaChange(m);
      };

      return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
          <div><label className="block text-sm text-slate-600 mb-1">Hospital Name</label>
            <input value={value.hospital||""} onChange={e=>wrapMeta({hospital:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Hospital name" /></div>
          <div><label className="block text-sm text-slate-600 mb-1">Address</label>
            <input value={value.address||""} onChange={e=>wrapMeta({address:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Address" /></div>
          <div><label className="block text-sm text-slate-600 mb-1">Date(s) of Visit</label>
            <input value={value.visitDates||""} onChange={e=>wrapMeta({visitDates:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="e.g., 15–16 Sep 2025" /></div>

          <div>
            <div className="flex items-center justify-between">
              <label className="block text-sm text-slate-600 mb-1">Assessor(s)</label>
              <button type="button" onClick={addAssessor} className="ml-2 inline-flex items-center justify-center rounded-md border border-slate-300 bg-white text-slate-700 px-2 py-1 text-xs hover:bg-slate-50" title="Add assessor">+</button>
            </div>
            <div className="space-y-2">
              {assessors.map((a, i)=>(
                <div key={i} className="grid grid-cols-5 gap-2 items-center">
                  <input
                    value={a.name||""}
                    onChange={e=>updateAssessor(i,'name', e.target.value)}
                    className="col-span-2 w-full rounded-xl border px-3 py-2"
                    placeholder="Assessor name"
                  />
                  <input
                    value={a.role||""}
                    onChange={e=>updateAssessor(i,'role', e.target.value)}
                    className="col-span-2 w-full rounded-xl border px-3 py-2"
                    placeholder="Role"
                  />
                  <button
                    type="button"
                    onClick={()=>removeAssessor(i)}
                    className="col-span-1 h-10 rounded-md border border-slate-300 bg-white text-slate-700 text-lg leading-none hover:bg-slate-50"
                    title="Remove"
                    aria-label="Remove"
                  >×</button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ---------------- SectionCard ----------------
    function SectionCard({ sec, data, onChange }){
      function setItem(id, patch){
        const next = { ...data, [id]: { ...data[id], ...patch } };
        onChange(next);
      }
      return (
        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-6">
          <h2 className="text-lg font-semibold text-slate-700 mb-3">{sec.code}. {sec.title}</h2>
          <div className="space-y-3">
            {sec.items.map(it=>(
              <div key={it.id} className="grid grid-cols-1 md:grid-cols-6 gap-2 items-start">
                <div className="md:col-span-3 text-slate-700">{it.text}</div>
                <div className="md:col-span-1">
                  <select
                    value={data[it.id]?.status||""}
                    onChange={e=>setItem(it.id,{status:e.target.value})}
                    className="w-full rounded-xl border px-2 py-1"
                  >
                    <option value=""></option>
                    {YNN.map(y=><option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
                <div className="md:col-span-2">
                  <input
                    value={data[it.id]?.remarks||""}
                    onChange={e=>setItem(it.id,{remarks:e.target.value})}
                    className="w-full rounded-xl border px-2 py-1"
                    placeholder="Remarks"
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }
    // ---------------- Print Helpers ----------------
    function buildPrintable(data, noncompOnly=false){
      const secs = [...SECTIONS, ...ANNEXURES];
      let html = `<h1 style="text-align:center;font-size:20px;margin-bottom:20px;">KSCCE Hospital Checklist Report</h1>`;
      html += `<p><b>Hospital:</b> ${data.hospital||""}<br/>
               <b>Address:</b> ${data.address||""}<br/>
               <b>Date(s):</b> ${data.visitDates||""}<br/>
               <b>Assessors:</b> ${(data.assessors||[]).map((a,i)=>`${i+1}. ${a.name||""}, ${a.role||""}`).join("; ")}</p>`;
      secs.forEach(sec=>{
        const secData = data[sec.code]||{};
        const rows = sec.items.filter(it=>{
          if (!noncompOnly) return true;
          return secData[it.id]?.status==="No";
        }).map(it=>{
          const st = secData[it.id]?.status||"";
          const rm = secData[it.id]?.remarks||"";
          return `<tr><td>${it.text}</td><td>${st}</td><td>${rm}</td></tr>`;
        }).join("");
        if (rows) {
          html += `<h2>${sec.code}. ${sec.title}</h2>
                   <table border="1" cellspacing="0" cellpadding="4" style="width:100%;border-collapse:collapse;font-size:13px;">
                     <tr><th>Item</th><th>Status</th><th>Remarks</th></tr>${rows}
                   </table>`;
        }
      });
      return html;
    }

    function openPrintWindow(innerHTML){
      const css = `
        body { font-family: Arial, Helvetica, sans-serif; color:#0f172a; padding:20px; }
        h1 { font-size:22px; margin-bottom:20px; }
        h2 { font-size:18px; margin-top:20px; }
        table { margin-top:10px; }
        th { background:#f1f5f9; }
      `;
      const win = window.open("", "Print", "width=900,height=650");
      win.document.write(`<html><head><style>${css}</style></head><body>${innerHTML}</body></html>`);
      win.document.close();
      win.focus();
      win.print();
    }

    // ---------------- ChecklistApp ----------------
    function ChecklistApp({ user }){
      const [data, setData] = useState({ assessors:[{name:user.email, role:""}] });
      const [loading, setLoading] = useState(false);
      const [collabId, setCollabId] = useState(null);

      // Sync state with Firestore
      useEffect(()=>{
        if (!collabId) return;
        const unsub = db().collection(ASSESS_COLL).doc(collabId).onSnapshot(doc=>{
          if (doc.exists){
            const incoming = doc.data();
            setData(prev=>{
              // merge instead of overwrite (fixes dropdown & remarks crash)
              const merged = { ...prev };
              for (const [key,val] of Object.entries(incoming)){
                if (typeof val==="object" && !Array.isArray(val)){
                  merged[key] = { ...(prev[key]||{}), ...val };
                } else {
                  merged[key] = val;
                }
              }
              return merged;
            });
          }
        });
        return ()=>unsub();
      }, [collabId]);

      // Debounced writer
      const writeTimer = useRef(null);
      function pushData(next){
        setData(next);
        if (collabId){
          if (writeTimer.current) clearTimeout(writeTimer.current);
          writeTimer.current = setTimeout(()=>{
            db().collection(ASSESS_COLL).doc(collabId).set(next,{merge:true});
          }, WRITE_DEBOUNCE_MS);
        }
      }

      // Toolbar actions
      function exportFull(){ openPrintWindow(buildPrintable(data,false)); }
      function exportNoncomp(){ openPrintWindow(buildPrintable(data,true)); }

      // Invite handling
      async function sendInvite(email){
        if (!await isAllowlisted(email)){ alert("Recipient not registered/allowlisted."); return; }
        const docId = safeId(user.email)+"_"+Date.now();
        await db().collection(INVITES_COLL).doc(docId).set({
          from:user.email, to:email, collabId: docId, status:"pending", created:Date.now()
        });
        await db().collection(ASSESS_COLL).doc(docId).set(data||{});
        alert("Invite sent!");
      }

      async function acceptInvite(inv){
        setCollabId(inv.collabId);
        await db().collection(INVITES_COLL).doc(inv.id).update({status:"accepted"});
      }

      // UI
      return (
        <div className="p-4 max-w-6xl mx-auto">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-xl font-bold text-slate-700">KSCCE Checklist <span className="text-xs text-slate-500">({VERSION})</span></h1>
            <div className="space-x-2">
              <button onClick={exportFull} className="px-3 py-1 rounded-lg border text-sm">Export Full</button>
              <button onClick={exportNoncomp} className="px-3 py-1 rounded-lg border text-sm">Export Non-Compliance</button>
            </div>
          </div>

          <HeaderFields value={data} onChange={setData} onMetaChange={pushData} />

          {[...SECTIONS, ...ANNEXURES].map(sec=>(
            <SectionCard key={sec.code} sec={sec} data={data[sec.code]||{}} onChange={next=>pushData({...data, [sec.code]:next})} />
          ))}

          {/* Collaboration Panel */}
          <div className="bg-white rounded-2xl border p-4 shadow-sm">
            <h2 className="font-semibold mb-2">Work as a Team</h2>
            <SendCollaboration user={user} onSend={sendInvite} />
            <AcceptCollaboration user={user} onAccept={acceptInvite} />
          </div>
        </div>
      );
    }
    // ---------------- Collaboration UI ----------------
    function SendCollaboration({ user, onSend }){
      const [email,setEmail] = useState("");
      return (
        <div className="mb-3">
          <div className="flex gap-2">
            <input value={email} onChange={e=>setEmail(e.target.value)} className="flex-1 rounded-xl border px-3 py-2" placeholder="Enter collaborator email" />
            <button onClick={()=>{ onSend(email); setEmail(""); }} className="px-3 py-2 rounded-lg border">Invite</button>
          </div>
        </div>
      );
    }

    function AcceptCollaboration({ user, onAccept }){
      const [invites,setInvites] = useState([]);
      useEffect(()=>{
        const unsub = db().collection(INVITES_COLL)
          .where("to","==",user.email)
          .onSnapshot(snap=>{
            const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
            setInvites(arr);
          });
        return ()=>unsub();
      },[user.email]);
      return (
        <div>
          <h3 className="font-medium text-slate-700 mb-1">Pending Invites</h3>
          {invites.map(inv=>(
            <div key={inv.id} className="flex items-center justify-between border rounded-lg p-2 mb-1">
              <span className="text-sm">{inv.from} → you</span>
              <button onClick={()=>onAccept(inv)} className="px-2 py-1 text-xs rounded-lg border">Accept</button>
            </div>
          ))}
          {invites.length===0 && <p className="text-sm text-slate-500">No invites</p>}
        </div>
      );
    }

    // ---------------- Auth Screen ----------------
    function AuthScreen(){
      const [email,setEmail] = useState("");
      const [pass,setPass] = useState("");
      const [error,setError] = useState("");

      async function login(){
        try {
          await auth().signInWithEmailAndPassword(email,pass);
        } catch(e){
          setError(e.message);
        }
      }

      return (
        <div className="h-screen flex items-center justify-center bg-slate-100">
          <div className="bg-white p-6 rounded-2xl shadow-md w-80">
            <h1 className="text-lg font-bold mb-4">KSCCE Login</h1>
            <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full mb-2 px-3 py-2 rounded-xl border" />
            <input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="Password" className="w-full mb-2 px-3 py-2 rounded-xl border" />
            {error && <p className="text-red-600 text-sm mb-2">{error}</p>}
            <button onClick={login} className="w-full py-2 rounded-lg border">Login</button>
          </div>
        </div>
      );
    }

    // ---------------- Root ----------------
    function App(){
      const [user,setUser] = useState(null);
      useEffect(()=>{
        return auth().onAuthStateChanged(u=>{
          if (u) setUser(u); else setUser(null);
        });
      },[]);
      if (!user) return <AuthScreen/>;
      return <ChecklistApp user={user}/>;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>