<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSCCE Hospital Checklist v2.2.3 â€” Live Collaboration</title>

  <!-- Tailwind for UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (dev preview) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .screen-only { display: block; }
    .print-only  { display: none; }
    @media print {
      .screen-only { display: none !important; }
      .print-only  { display: block !important; }
      body { background: #fff !important; }
    }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="screen-only"></div>
  <div id="sheet-full" class="print-only"></div>
  <div id="sheet-noncomp" class="print-only"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const VERSION = "v2.2.3";
    const INVITES_COLL = "collabInvites";
    const ASSESS_COLL  = "assessments";
    const PRESENCE_COLL= "presence";
    const TYPING_IDLE_MS = 1200;
    const PRESENCE_HEARTBEAT_MS = 20000; // 20s
    const PRESENCE_STALE_MS = 60000;     // 60s
    const WRITE_DEBOUNCE_MS = 400;       // keystroke batching

    // ---------------- Firebase ----------------
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDKSvo5KNuXPq83284_6GOnxXisKA_lSks",
      authDomain: "kssce-51e3e.firebaseapp.com",
      projectId: "kssce-51e3e",
      storageBucket: "kssce-51e3e.appspot.com",
      messagingSenderId: "308291560377",
      appId: "1:308291560377:web:ae634dd42e9ac1459e0c68"
    };
    try { if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG); } catch(e) { console.warn(e); }
    const auth = () => firebase.auth();
    const db   = () => firebase.firestore();

    async function isAllowlisted(email){
      if (!email) return false;
      try {
        const doc = await db().doc('allowlist/' + String(email).trim().toLowerCase()).get();
        return doc.exists;
      } catch (err) { console.warn("Allowlist check failed:", err); return false; }
    }

    // Helpers
    const safeId = (email) => encodeURIComponent(String(email||"").toLowerCase());
    const initials = (email) => (String(email||"?").trim()[0]||"?").toUpperCase();

    // ---------------- Data ----------------
    const YNN = ["Yes","No","N/A"];
    const SECTIONS = [
      { code: "A", title: "General", items: [
        { id: "ic-measures", text: "Hospital should adopt infection control measures." },
        { id: "bmw", text: "Appropriate arrangements for Bio-Medical Waste (BMW) management should be in place." },
        { id: "med-records", text: "Medical Records should be maintained by either in hard or soft copy." },
        { id: "lab-services", text: "Laboratory Services should be available. The same could be dedicated set up or a collection centre with appropriate arrangements for forwarding samples and specimens as well as effective deliverance of results." },
        { id: "birth-death", text: "Birth and death information register should be maintained." },
        { id: "power-backup", text: "Back up facility for electricity failure which covers essential activities should be available." },
        { id: "fire-ext", text: "Fire extinguishers should be available." },
        { id: "linen", text: "Facility for clean/ sterilized linens should be available." },
        { id: "ambulance", text: "Ambulance service arrangement should be in place." },
        { id: "display-services", text: "Display of Services provided and Rates & Packages." },
        { id: "charges-info", text: "Information regarding the services and their approximate charges should be provided by the administration of the hospital." }
      ]},
      { code: "B", title: "OPD", items: [
        { id: "opd-basics", text: "Availability of stethoscope, Torch, Thermometer (Preferably non-mercury), BP Apparatus (Preferably non-mercury), Hand wash facility, Examination table, chairs or stools for the doctor, patient and bystander." },
        { id: "female-attendant", text: "Female attendant for female patients, Privacy to Patients, Information Material for Patients." },
        { id: "registration", text: "Registration of Patients: Name, Age, Sex and contact details (at least mobile number) of the patient should be entered and available in hard or softcopy." },
        { id: "waiting-amenities", text: "Waiting Area, Drinking Water facility and separate male & female toilets should be available." },
        { id: "doc-display", text: "The names of the doctors with their qualifications should be displayed." }
      ]},
      { code: "C", title: "Casualty / Emergency", items: [
        { id: "cas-hr", text: "Human resources supporting the casualty services should be available during the working hours." },
        { id: "cas-drugs-eq", text: "Emergency drugs and equipments should be available according to the scope of the services." },
        { id: "cas-signage", text: "Signage board of the casualty should be displayed at the entrance and be easily visible." },
        { id: "ramp", text: "Patient friendly ramp or slope facility should be available." },
        { id: "stretchers", text: "Stretchers/wheel chairs should be available." }
      ]},
      { code: "D", title: "Inpatient (IPD)", items: [
        { id: "dept-signs", text: "Signboards of different departments and wards should be displayed." },
        { id: "on-call-doc", text: "A doctor should be available on call." },
        { id: "nursing-trained", text: "Personnel trained in nursing for at least 1 year should be available." },
        { id: "beds", text: "Beds should be made available to provide inpatient treatment." },
        { id: "call-system", text: "There should be a system to call the nurses and other attendants (Intercom/Call Bell)." },
        { id: "ipd-basics", text: "Hand Washing Facility/Hand Sanitizer, Bed pan, Waste bins, Attendants Chair/ Stool should be available." },
        { id: "ipd-amenities", text: "Drinking water facility and gender specific toilets should be available." }
      ]},
      { code: "E", title: "OP Cabin Registration Standards", items: [
        { id: "physician-display", text: "Name of the physician with qualification & Registration Number should be displayed." },
        { id: "op-equip", text: "Chairs/ Stool, Examination table, Torch, Thermometer (preferably non- mercurial), BP apparatus (preferably non-mercurial), Stethoscope should be available." },
        { id: "handwash-wait", text: "Hand washing facility, Drinking Water and waiting space should be present." }
      ]},
      { code: "F", title: "Laboratory Registration Standards", items: [
        { id: "lab-consultant", text: "Name of the Consultant with qualification and registration Number displayed." },
        { id: "lab-charges", text: "Display of services & Charges." },
        { id: "lab-equip", text: "Equipments and instruments as per the work load and scope of services." }
      ]},
      { code: "G", title: "Signage", items: [
        { id: "bi-lang", text: "Appropriate signage which shall be in at least two languages (English and Malayalam). A board stating â€˜24 hours emergency availableâ€™ is desirable." },
        { id: "name-board", text: "Board displaying the name of the hospital at a prominent location." },
        { id: "provider-reg", text: "Name of the care provider with registration number." },
        { id: "reg-details", text: "Registration details of the hospital as applicable as per KCEA 2018." },
        { id: "fee-structure", text: "Availability of fee structure of the various services provided (as per KCEA 2018)." },
        { id: "timings", text: "Timings of the hospital and services provided." },
        { id: "mandatory-info", text: "Mandatory information such as under PNDT Act etc. displayed prominently as applicable." },
        { id: "important-contacts", text: "Important contact numbers such as Blood Banks, Fire Department, Police and Ambulance Services available in the nearby area." },
        { id: "hazard-signs", text: "Safety Hazard and Caution signs, e.g. hazards from electrical shock, inflammable articles, radiation etc. at appropriate places, and as applicable under law." },
        { id: "fire-exit", text: "Appropriate Fire exit signage." },
        { id: "no-smoking", text: "Signage for â€˜No Smokingâ€™ at prominent places." }
      ]},
      { code: "H", title: "Infrastructure â€“ Other Requirements", items: [
        { id: "entry", text: "Convenient entry point to the hospital." },
        { id: "pwd", text: "Access within the requirements of â€˜Persons with Disabilities Actâ€™ and for all those whose mobility may be restricted due to whatever cause." },
        { id: "hygiene", text: "Safe, clean and hygienic environment for patients, their attendants, staff and visitors." },
        { id: "water-power", text: "24 hour provision of potable water for drinking & hand hygiene, 24 hour supply of electricity, either through direct supply or from other sources like UPS back up, generator facility etc." },
        { id: "public-toilets", text: "Clean public toilet(s) separate for males and females and disabled friendly." },
        { id: "furniture", text: "Furniture and fixtures shall be available in accordance with the activities and workload of the hospital. They shall be functional and properly maintained. Indicative list of furniture and fixtures is as per Annexure 1." }
      ]},
      { code: "I", title: "Infrastructure â€“ Space Requirements", items: [
        { id: "waiting-100", text: "Reception & Waiting area â€“ 100 sq. ft" },
        { id: "consult-80", text: "Consultation cabin with Physical Examination table â€“ 80 sq. ft each" },
        { id: "pharmacy-40", text: "Storage & Pharmacy â€“ 40 sq. ft" },
        { id: "ancillary-60", text: "Ancillary Area â€“ 60 sq. ft" },
        { id: "ward-circ", text: "Circulation space of 30% shall be provided for Nursing station, Ward store, Sanitary etc." },
        { id: "ot-recep", text: "OT (Minor): Reception & Waiting area - 9.2 sq. mt" },
        { id: "ot-consult", text: "OT (Minor): Consultation cabin with Physical Examination table - 7.4 sq. mt each; examination area 3.71 sq. mt" },
        { id: "ot-ancillary", text: "OT (Minor): Storage & Pharmacy / Ancillary Area - 5.57 sq. mt" },
        { id: "ward-areas", text: "The ward shall also have designated areas for nursing station, doctorsâ€™ duty room, store, clean and dirty utility, janitor room, toilets and this shall be provided from circulation area." },
        { id: "ward-basin", text: "For a general ward of 20 beds, a minimum of 1 working counter and 1 hand wash basin shall be provided." },
        { id: "bed-gap", text: "Distance between beds shall be 1.0 metres (Desirable)." },
        { id: "head-space", text: "Space at the head end of bed shall be 0.25 metres." },
        { id: "door-corr", text: "Door width shall be 1.2 metres (Desirable) and corridor width 2.5 metres (Desirable)." }
      ]},
      { code: "J", title: "Medical Equipment & Instruments", items: [
        { id: "adequate-equip", text: "Adequate medical equipments and instruments, commensurate to the scope of service and number of beds." },
        { id: "maint-sys", text: "There shall be established system for maintenance of critical equipment." },
        { id: "amc", text: "Equipment shall be kept in good working condition through periodic inspection, cleaning and maintenance (AMC)." }
      ]},
      { code: "K", title: "Drugs, Medical Devices & Consumables", items: [
        { id: "adequate-drugs", text: "Adequate drugs, medical devices and consumables." },
        { id: "emg-drugs", text: "Emergency drugs and consumables shall be available at all times." },
        { id: "drug-storage", text: "Drug storage shall be in a clean, well lit, and safe environment and shall be in consonance with applicable laws and regulations." },
        { id: "inventory", text: "The facility shall have defined procedures for storage, inventory management and dispensing of drugs in pharmacy and patient care areas." }
      ]},
      { code: "L", title: "Human Resources", items: [
        { id: "nursing-hr", text: "Qualified and/or trained nursing staff as per the scope of service provided; nursing care as per professional and regulatory requirements." },
        { id: "paramed-hr", text: "Qualified and/or trained paramedical staff as per the scope of service provided; medical care as per professional and regulatory requirements." },
        { id: "staff-records", text: "For every staff (including contractual staff), there shall be personal record containing appointment order, documentary evidence of qualification and/or training (and professional registration where applicable)." },
        { id: "mbbs-req", text: "Qualified doctor shall be available during the working hours. MBBS Doctor required round the clock only if inpatient services are provided. Advanced primary care: MBBS doctor with post-graduation; Specialized Doctor on call." },
        { id: "nurse-exp", text: "Trained Nurses with â‰¥1 year experience â€” at least 1 in a hospital." },
        { id: "pharmacist", text: "Pharmacist (if in-house pharmacy available) â€” at least 1." },
        { id: "lab-tech", text: "Lab Technician (if in-house laboratory service available) â€” at least 1." },
        { id: "xray-tech", text: "X-ray Technician (if in-house X-ray facility available) â€” at least 1." },
        { id: "mts", text: "Multi Task staff â€” minimum 1." }
      ]},
      { code: "M", title: "Support Services", items: [
        { id: "reg-billing", text: "Have a Registration/ Help-desk & Billing counter." },
        { id: "diag", text: "Diagnostic services may be in-house or outsourced as per minimum standards for diagnostic services." },
        { id: "pharmacy", text: "Pharmacy services available, in-house or outsourced." }
      ]},
      { code: "N", title: "Waste Management Services", items: [
        { id: "general-waste", text: "Segregation, collection, transportation, storage and disposal of general waste as per applicable local laws." },
        { id: "bmw-rules", text: "Segregation, collection, transportation, storage and disposal of biomedical waste as per Bio Medical Waste Handling Rules." }
      ]},
      { code: "O", title: "Legal / Statutory", items: [
        { id: "local-law", text: "Compliance with local regulations and law." },
        { id: "ce-reg", text: "Clinical Establishments Registration (if applicable)." },
        { id: "pcb-bmw", text: "Bio-medical Waste Management Licenses from PCB." },
        { id: "other-lic", text: "Mandatory Licenses from concerned authorities as per the scope of services." }
      ]},
      { code: "P", title: "Records & Reporting", items: [
        { id: "min-records", text: "The minimum medical records to be maintained shall be as per Annexure 4 and as per KCEA 2018." },
        { id: "record-format", text: "Medical Records shall be maintained in physical or digital format." },
        { id: "ipd-records", text: "The medical records of IPD patients shall be maintained in consonance with National or local law, MCI guidelines, and court orders." }
      ]}
    ];

    const ANNEXURE_SECTIONS = [
      { code: "Annexure 1", title: "ANNEXURE 1 â€” FURNITURE AND FIXTURES", items: [
        "Examination Table","Writing tables","Chairs","Almirah","Waiting Benches","Inpatient Beds","Labour Table- if applicable","Wheel Chair/Stretcher","Medicine Trolley, Instrument Trolley","Screens/curtains","Foot Step","Bed Side Table","Baby Cot- if applicable","Stool","Medicine Chest","Examination Lamp","View box","Fans","Tube Light/ lighting fixtures","Wash Basin","IV Stand","Color coded bins for BMW"
      ].map((x,i)=>({id:'a1-'+i,text:x})) },
      { code: "Annexure 2", title: "ANNEXURE 2 â€” ESSENTIAL EQUIPMENTS AND INSTRUMENTS", items: [
        "Stethoscope","Thermometer Digital","Torch (flash lights)","Sphygmomanometer (B. P. Apparatus) Digital","Weighing Machine Adult/Pediatric","Glucometer","Pulse Oximeter","Syringe & Needles Different size","Examination gloves","Examination table","Otoscope","Patellar hammer","Receptacle for soiled pads, dressings, etc","Sterile equipment storage","Sutures","Thermometer (Non mercury)","Dressing trolley","IV stands","Medicine storage cabinet","Oxygen cylinder","Suction machine","Urinals and bedpans","Linens"
      ].map((x,i)=>({id:'a2-'+i,text:x})) },
      { code: "Annexure 3", title: "ANNEXURE 3 â€” Emergency Drugs and consumables (Essential in all hospitals)", items: [
        "INJ. DIAZEPAM 10MG","INJ. FRUSEMIDE 20MG","INJ. ONDANSETRON 8MG/4ML","INJ. RANITIDINE","INJ. NOR ADRENALINE 4MG","INJ. PHENYTOIN 50MG","INJ. DICLOFENAC 75MG","INJ. DERIPHYLLINE","INJ. CHLORPHENIRAMINEMALEATE","INJ. HYDROCORTISONE 100MG","INJ. ATROPINE 0.6MG","INJ. ADRENALINE 1MG","INJ. KCL","STERILE WATER","INJ. SODABICARBONATE","INJ. DOPAMINE","INJ. NALAXONE 400MCG","INJ. LIGNOCAINE 50ML","TAB. SORBITRATE","TAB. ASPIRIN","INJ. TETANUS TOXOID","NEB. SALBUTAMOL 2.5ML","NEB. BUDESONIDE","LIGNOCAINE JELLY 2%","CALCIUM (INJ or TAB)","RL 500ML","NS 500ML","NS 250ML","NS 100ML","DNS 500ML","DEXTROSE 5% 500ML","DEXTROSE 10% 500ML","PEDIATRIC IV INFUSION SOLUTION 500ML"
      ].map((x,i)=>({id:'a3-'+i,text:x})) },
      { code: "Annexure 4", title: "ANNEXURE 4 â€” CONTENT OF MEDICAL RECORD", items: [
        "Name & Registration number of treating doctor","Name, demographic details & contact number of patient","Relevant Clinical history, Assessment and re-assessment findings, nursing notes and Diagnosis","Investigation reports","Details of medical treatment, invasive procedures, surgery and other care provided","Applicable consents","Discharge summary","Cause-of-death certificate & Death Summary (where applicable)"
      ].map((x,i)=>({id:'a4-'+i,text:x})) },
    ];

    // ---------------- UI: Assessors ----------------
    function HeaderFields({ value, onChange, onMetaChange }){
      const assessors = Array.isArray(value.assessors) && value.assessors.length
        ? value.assessors
        : [{ name: value.assessor || "", role: value.assessorRole || "" }];

      function setAssessors(next){
        const first = next[0] || { name: "", role: "" };
        const updated = { ...value, assessors: next, assessor: first.name || "", assessorRole: first.role || "" };
        onChange(updated);
        onMetaChange && onMetaChange(updated);
      }
      function updateAssessor(idx, field, val){
        const next = assessors.map((a,i)=> i===idx ? { ...a, [field]: val } : a);
        setAssessors(next);
      }
      function addAssessor(){ setAssessors([...assessors, { name: "", role: "" }]); }
      function removeAssessor(idx){
        const next = assessors.filter((_,i)=>i!==idx);
        setAssessors(next.length ? next : [{ name:"", role:"" }]);
      }

      const wrapMeta = (patch) => {
        const m = { ...value, ...patch };
        onChange(m);
        onMetaChange && onMetaChange(m);
      };

      return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
          <div><label className="block text-sm text-slate-600 mb-1">Hospital Name</label>
            <input value={value.hospital||""} onChange={e=>wrapMeta({hospital:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Hospital name" /></div>
          <div><label className="block text-sm text-slate-600 mb-1">Address</label>
            <input value={value.address||""} onChange={e=>wrapMeta({address:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Address" /></div>
          <div><label className="block text-sm text-slate-600 mb-1">Date(s) of Visit</label>
            <input value={value.visitDates||""} onChange={e=>wrapMeta({visitDates:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="e.g., 15â€“16 Sep 2025" /></div>

          <div>
            <div className="flex items-center justify-between">
              <label className="block text-sm text-slate-600 mb-1">Assessor(s)</label>
              <button type="button" onClick={addAssessor} className="ml-2 inline-flex items-center justify-center rounded-md border border-slate-300 bg-white text-slate-700 px-2 py-1 text-xs hover:bg-slate-50" title="Add assessor">+</button>
            </div>
            <div className="space-y-2">
              {assessors.map((a, i)=>(
                <div key={i} className="grid grid-cols-5 gap-2 items-center">
                  <input
                    value={a.name||""}
                    onChange={e=>updateAssessor(i,'name', e.target.value)}
                    className="col-span-2 w-full rounded-xl border px-3 py-2"
                    placeholder="Assessor name"
                  />
                  <input
                    value={a.role||""}
                    onChange={e=>updateAssessor(i,'role', e.target.value)}
                    className="col-span-2 w-full rounded-xl border px-3 py-2"
                    placeholder="Role"
                  />
                  <button
                    type="button"
                    onClick={()=>removeAssessor(i)}
                    className="col-span-1 h-10 rounded-md border border-slate-300 bg-white text-slate-700 text-lg leading-none hover:bg-slate-50"
                    title="Remove"
                    aria-label="Remove"
                  >Ã—</button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function SectionCard({ section, state, setState, onFieldChange, typingMap }){
      return (
        <div className="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
          <div className="px-4 py-2.5 bg-slate-50 border-b border-slate-200">
            <div className="font-semibold text-slate-900 tracking-wide">{section.code}. {section.title}</div>
          </div>
          <div className="divide-y">
            {section.items.map((it,idx)=>{
              const key=section.code + '-' + it.id;
              const row=state[key]||{v:"",note:""};
              const whoTyping = typingMap[key]; // array of emails typing here
              return (
                <div key={key} className="p-4 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                  <div className="md:col-span-7 text-slate-800">
                    <span className="text-slate-400 mr-2">{idx+1}.</span>{it.text}
                  </div>
                  <div className="md:col-span-2">
                    <select
                      value={row.v}
                      onChange={e=>{
                        const val = e.target.value;
                        setState(s=>({...s,[key]:{...s[key],v:val}}));
                        onFieldChange && onFieldChange({type:'answer', key, sub:'v', val});
                      }}
                      className="w-full rounded-xl border px-3 py-2"
                    >
                      <option value="">Select</option>
                      {YNN.map(x=>(<option key={x} value={x}>{x}</option>))}
                    </select>
                  </div>
                  <div className="md:col-span-3">
                    <input
                      value={row.note||""}
                      onChange={e=>{
                        const val = e.target.value;
                        setState(s=>({...s,[key]:{...s[key],note:val}}));
                        onFieldChange && onFieldChange({type:'answer', key, sub:'note', val, typing:true});
                      }}
                      onFocus={()=>onFieldChange && onFieldChange({type:'typing', key, sub:'note', on:true})}
                      onBlur ={()=>onFieldChange && onFieldChange({type:'typing', key, sub:'note', on:false})}
                      placeholder="Notes / remarks" className="w-full rounded-xl border px-3 py-2"
                    />
                    {whoTyping && whoTyping.length ? (
                      <div className="mt-1 text-[11px] text-slate-500">
                        {whoTyping.map(e=>e.split('@')[0]).join(', ')} typingâ€¦
                      </div>
                    ): null}
                  </div>
                </div>
              )
            })}
          </div>
        </div>
      );
    }
    // ------- Print header & helpers -------
    function PdfHeader(){
      return (
        <div>
          <div style={{fontWeight:700, textAlign:'center'}}>KERALA STATE COUNCIL FOR CLINICAL ESTABLISHMENTS</div>
          <div style={{fontSize:12, textAlign:'center', lineHeight:1.35, marginTop:4}}>
            2nd Floor, Hostel Block of Kerala State Institute of Health and Family Welfare, Thycaud, Thiruvananthapuram -14<br/>
            Phone: 0471-2966523, e-mail: kscce2018@gmail.com<br/>
            Website: www.clinicalestablishments.kerala.gov.in
          </div>
        </div>
      );
    }
    function formatAssessorsList(meta){
      const arr = Array.isArray(meta.assessors) ? meta.assessors
                : (meta.assessor ? [{ name: meta.assessor, role: meta.assessorRole || "" }] : []);
      const cleaned = arr.filter(a => (a?.name||"").trim() || (a?.role||"").trim());
      if (!cleaned.length) return "";
      return cleaned.map((a,i)=>{
        const nm = (a?.name||"").trim();
        const rl = (a?.role||"").trim();
        const pair = [nm, rl].filter(Boolean).join(", ");
        return `${i+1}. ${pair}`;
      }).join(" ; ");
    }
    function MetaTablePrint({ meta }){
      return (
        <table className="meta" style={{width:'100%', borderCollapse:'collapse', marginTop:8}}>
          <tbody>
            <tr>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', width:'30%', fontWeight:600}}>Name & Address of the Hospital:</td>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px'}}>{(meta.hospital||"") + (meta.address? (", " + meta.address) : "")}</td>
            </tr>
            <tr>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', fontWeight:600}}>Date(s) of Visit:</td>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px'}}>{meta.visitDates || ""}</td>
            </tr>
            <tr>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', fontWeight:600}}>Name of Assessors:</td>
              <td style={{border:'1px solid #cbd5e1', padding:'6px 8px'}}>{formatAssessorsList(meta)}</td>
            </tr>
          </tbody>
        </table>
      );
    }
    function KscceTitle({ text }){ return (<div style={{fontWeight:700, margin:'10px 0 6px'}}>{text}</div>); }
    function FullReport({ meta, answers }){
      return (
        <div className="p-6 text-slate-900">
          <PdfHeader/><KscceTitle text="Checklist for Hospital" /><MetaTablePrint meta={meta} />
          {[...SECTIONS, ...ANNEXURE_SECTIONS].map(s=> (
            <div key={s.code} style={{marginTop:14, breakInside:'avoid'}}>
              <div style={{fontWeight:600, margin:'6px 0'}}>{s.code}. {s.title}</div>
              <table style={{borderCollapse:'collapse', width:'100%'}}>
                <thead>
                  <tr>
                    <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left', width:'8%'}}>Sl. No.</th>
                    <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left'}}>Item</th>
                    <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left', width:'12%'}}>Answer</th>
                    <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left', width:'30%'}}>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {s.items.map((it, idx)=>{
                    const key = s.code + '-' + it.id;
                    const row = answers[key] || {};
                    return (
                      <tr key={key}>
                        <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{idx+1}</td>
                        <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{it.text}</td>
                        <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{row.v || ""}</td>
                        <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{row.note || ""}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ))}
        </div>
      );
    }
    function NonCompReport({ meta, answers }){
      const rows = [];
      for (const s of [...SECTIONS, ...ANNEXURE_SECTIONS]){
        for (const it of s.items){
          const key=s.code + '-' + it.id;
          const ans=answers[key]?.v||"";
          if (ans === "No") rows.push({ section: s.code + ". " + s.title, item: it.text, note: answers[key]?.note||"" });
        }
      }
      return (
        <div className="p-6 text-slate-900">
          <PdfHeader/><KscceTitle text="Non-Compliance Report â€” Checklist (Hospital)" /><MetaTablePrint meta={meta} />
          {rows.length ? (
            <table style={{borderCollapse:'collapse', width:'100%', marginTop:8}}>
              <thead>
                <tr>
                  <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left', width:'25%'}}>Section</th>
                  <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left'}}>Item</th>
                  <th style={{border:'1px solid #cbd5e1', padding:'6px 8px', textAlign:'left', width:'35%'}}>Notes / Corrective Action</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r,i)=> (
                  <tr key={i}>
                    <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{r.section}</td>
                    <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{r.item}</td>
                    <td style={{border:'1px solid #cbd5e1', padding:'6px 8px', verticalAlign:'top'}}>{r.note}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          ) : (<p className="mt-3 text-sm">No items marked as "No".</p>)}
        </div>
      );
    }

    // ------- Print helpers -------
    function openPrintWindow(innerHTML){
      const css = `
        body { font-family: Arial, Helvetica, sans-serif; color:#0f172a; margin:0; }
        .wrap { padding: 18px 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #cbd5e1; padding: 6px 8px; font-size: 12px; vertical-align: top; }
        thead th { background: #f1f5f9; }
        .meta td { border: 1px solid #cbd5e1; padding: 6px 8px; }
        h1, h2, h3 { margin: 0; }
        @media print { .page-break { page-break-before: always; } }
      `;
      const w = window.open('', '_blank');
      if (!w) { alert("Popup blocked. Allow popups to export."); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>KSCCE Export</title><style>${css}</style></head><body><div class="wrap">${innerHTML}</div></body></html>`);
      w.document.close();
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e) {} }, 250);
    }

    // --------- Header & Tabs ---------
    function HeaderBar({ email, tab, onTab, onSignOut }){
      const TABS = ["Checklist","Annexure 1","Annexure 2","Annexure 3","Annexure 4"];
      return (
        <header className="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 rounded-xl bg-teal-600 text-white grid place-items-center font-bold">KS</div>
              <div>
                <div className="font-semibold text-slate-900">KSCCE Hospital Checklist</div>
                <div className="text-xs text-slate-500 leading-tight">{email ? `Logged in as ${email}` : "Assessor Portal"}</div>
              </div>
            </div>
            <button onClick={onSignOut} className="px-3 py-1.5 rounded-full text-sm border bg-white text-slate-700">Sign out</button>
          </div>
          <div className="border-t border-slate-200 bg-white/80 backdrop-blur">
            <div className="max-w-6xl mx-auto px-3 py-2">
              <div className="hide-scrollbar overflow-x-auto whitespace-nowrap">
                <div className="inline-flex gap-2 min-w-full">
                  {TABS.map(t => (
                    <button key={t} onClick={()=>onTab(t)} className={`px-3 py-1.5 rounded-full text-sm border flex-shrink-0 ${tab===t?"bg-teal-600 text-white border-teal-700":"bg-white text-slate-700 border-slate-200"}`}>{t}</button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </header>
      );
    }

    // ---------- Debounce util ----------
    function makeDebounced(fn, wait=WRITE_DEBOUNCE_MS){
      let t=null, pending=null;
      return (patch)=>{
        pending = { ...(pending||{}), ...patch };
        clearTimeout(t);
        t=setTimeout(()=>{ const p=pending; pending=null; fn(p); }, wait);
      };
    }
    function ChecklistApp({ userEmail }){
      const [meta,setMeta]=useState({hospital:"",address:"",visitDates:"",assessor:""});
      const [answers,setAnswers]=useState({});
      const [tab,setTab]=useState("Checklist");
      const [lastEdited,setLastEdited]=useState("");

      // Team + live
      const [showTeam, setShowTeam] = useState(false);
      const [inviteEmail, setInviteEmail] = useState("");
      const [incomingInvites, setIncomingInvites] = useState([]);
      const [outgoingInvites, setOutgoingInvites] = useState([]);
      const [liveSessionId, setLiveSessionId] = useState(null);
      const [liveParticipants, setLiveParticipants] = useState([]);
      const [typingMap, setTypingMap] = useState({}); // key -> [emails]
      const [whoTypingTop, setWhoTypingTop] = useState([]); // overall typing

      const userEmailLower = (userEmail||"").toLowerCase();
      const SESSION_KEY = 'kscce-live-session-' + (userEmailLower || 'anon');

      // local persistence
      const storageKey = 'kscce-' + VERSION + '-' + (userEmail || "local");
      useEffect(()=>{
        const raw=localStorage.getItem(storageKey);
        if(raw){ try{ const p=JSON.parse(raw); setMeta(p.meta||{}); setAnswers(p.answers||{}); }catch{} }
      },[]);
      useEffect(()=>{
        localStorage.setItem(storageKey,JSON.stringify({meta,answers}));
        setLastEdited(new Date().toLocaleString());
      },[meta,answers]);

      // Restore live session across refresh
      useEffect(()=>{
        const sid = localStorage.getItem(SESSION_KEY);
        if (sid && !liveSessionId) {
          attachLiveSession(sid).then(()=>{
            setLiveSessionId(sid);
          }).catch(()=>{
            try { localStorage.removeItem(SESSION_KEY); } catch {}
          });
        }
        // eslint-disable-next-line react-hooks/exhaustive-deps
      },[]);

      function saveLocal(){
        const data = JSON.stringify({version:VERSION, meta, answers}, null, 2);
        const blob = new Blob([data],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(meta.hospital||'Hospital') + '-' + new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
      }
      function loadLocal(e){
        const file=e.target.files?.[0]; if(!file) return;
        const r=new FileReader();
        r.onload=()=>{ try{ const j=JSON.parse(r.result); setMeta(j.meta||{}); setAnswers(j.answers||{}); }catch{ alert('Invalid JSON'); } };
        r.readAsText(file); e.target.value='';
      }

      // ----- Invites (pending lists) -----
      useEffect(()=>{
        if(!userEmailLower) return;
        const qIn  = db().collection(INVITES_COLL)
          .where('recipient','==',userEmailLower)
          .where('status','in',['pending']);
        const qOut = db().collection(INVITES_COLL)
          .where('sender','==',userEmailLower)
          .where('status','in',['pending']);
        const unsubIn  = qIn.onSnapshot(snap=>{
          const arr=[]; snap.forEach(doc=> arr.push({id:doc.id,...doc.data()})); setIncomingInvites(arr);
        }, err=>console.warn(err));
        const unsubOut = qOut.onSnapshot(snap=>{
          const arr=[]; snap.forEach(doc=> arr.push({id:doc.id,...doc.data()})); setOutgoingInvites(arr);
        }, err=>console.warn(err));
        return ()=>{ try{unsubIn&&unsubIn();}catch{} try{unsubOut&&unsubOut();}catch{} };
      },[userEmailLower]);

      // ----- Presence -----
      const presenceTimer = useRef(null);
      const typingTimer = useRef(null);
      const presenceUnsub = useRef(null);

      async function startPresence(sessionId){
        if(!sessionId) return;
        clearInterval(presenceTimer.current);
        presenceTimer.current = setInterval(async ()=>{
          try{
            await db().collection(PRESENCE_COLL).doc(safeId(userEmailLower)).set({
              email: userEmailLower,
              sessionId,
              lastActive: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          }catch(e){ console.warn("presence heartbeat fail", e); }
        }, PRESENCE_HEARTBEAT_MS);
        try{
          await db().collection(PRESENCE_COLL).doc(safeId(userEmailLower)).set({
            email: userEmailLower,
            sessionId,
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }catch(e){}
        presenceUnsub.current && presenceUnsub.current();
        presenceUnsub.current = db().collection(PRESENCE_COLL).where('sessionId','==',sessionId).onSnapshot(snap=>{
          const now = Date.now();
          const online = [];
          const typingEntries = [];
          const keyToEmails = {};
          snap.forEach(doc=>{
            const d = doc.data();
            const ts = d.lastActive?.toDate ? d.lastActive.toDate().getTime() : 0;
            if (now - ts <= PRESENCE_STALE_MS) {
              online.push(d.email);
              if (d.typingKey) {
                typingEntries.push({ email: d.email, key: d.typingKey, sub: d.typingSub||'' });
                keyToEmails[d.typingKey] = (keyToEmails[d.typingKey]||[]).concat([d.email]);
              }
            }
          });
          setLiveParticipants(online);
          setWhoTypingTop(typingEntries.map(t=>t.email));
          setTypingMap(keyToEmails);
        }, err=>console.warn(err));
      }
      async function stopPresence(){
        clearInterval(presenceTimer.current);
        presenceTimer.current = null;
        presenceUnsub.current && presenceUnsub.current();
        presenceUnsub.current = null;
        try{
          await db().collection(PRESENCE_COLL).doc(safeId(userEmailLower)).set({
            sessionId: null,
            typingKey: null,
            typingSub: null,
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }catch(e){}
      }

      // ----- Live session (subscribe to the assessment doc) -----
      const remoteApplyingRef = useRef(false);
      const assessUnsub = useRef(null);

      async function attachLiveSession(id){
        if(!id) return;

        assessUnsub.current && assessUnsub.current();
        assessUnsub.current = db().collection(ASSESS_COLL).doc(id).onSnapshot(doc=>{
          const data = doc.data();
          if(!data) return;

          // ðŸ”’ prevent echo & flicker
          if (doc.metadata && doc.metadata.hasPendingWrites) return;
          if (data.lastWriter && data.lastWriter === userEmailLower) return;

          remoteApplyingRef.current = true;
          try {
            if (data.meta) {
              setMeta(prev => ({ ...prev, ...(data.meta || {}) }));
            }
            if (data.answers) {
              setAnswers(prev => ({ ...prev, ...(data.answers || {}) }));
            }
            setLiveParticipants(Array.isArray(data.participants)? data.participants : []);
          } finally {
            setTimeout(()=>{ remoteApplyingRef.current = false; }, 0);
          }
        }, err=>console.warn(err));

        await startPresence(id);
        try { localStorage.setItem(SESSION_KEY, id); } catch {}
      }

      async function detachLiveSession(removeFromParticipants){
        assessUnsub.current && assessUnsub.current();
        assessUnsub.current = null;
        await stopPresence();
        if (liveSessionId && removeFromParticipants) {
          try{
            await db().collection(ASSESS_COLL).doc(liveSessionId).set({
              participants: firebase.firestore.FieldValue.arrayRemove(userEmailLower),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastWriter: userEmailLower
            }, { merge: true });
          }catch(e){ console.warn(e); }
        }
        setLiveSessionId(null);
        setTypingMap({});
        setWhoTypingTop([]);
        try { localStorage.removeItem(SESSION_KEY); } catch {}
      }

      // ----- Debounced push to Firestore -----
      const debouncedPush = useRef(null);
      useEffect(()=>{
// ----- Debounced push to Firestore -----
      const debouncedPush = useRef(null);
      useEffect(()=>{
        debouncedPush.current = makeDebounced(async (patch)=>{
          if(!liveSessionId) return;
          try{
            const updates = {
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastWriter: userEmailLower
            };

            // Meta = write whole object (safe)
            if (patch.meta){
              Object.assign(updates, { meta: patch.meta });
            }

            // âœ… NEW: answersPath = field-level updates (e.g., answers.A-ic-measures.v)
            if (patch.answersPath){
              for (const [subPath, val] of Object.entries(patch.answersPath)){
                updates[`answers.${subPath}`] = val;
              }
            }

            // (Back-compat) If someone still passes full answers blocks,
            // we keep it â€” but field-level writes above are the new default.
            if (patch.answers){
              for (const [k,v] of Object.entries(patch.answers)){
                updates[`answers.${k}`] = v;
              }
            }

            await db().collection(ASSESS_COLL).doc(liveSessionId).set(updates, { merge: true });
          }catch(e){ console.warn("Sync failed", e); }
        }, WRITE_DEBOUNCE_MS);
      },[liveSessionId, userEmailLower]);

      // ----- Hook for changes/typing (edited) -----
      function onFieldChange(evt){
// ----- Hook for changes/typing (field-level for answers) -----
      function onFieldChange(evt){
        if (evt.type === 'answer') {
          const k = evt.key;             // e.g., "A-ic-measures"
          const sub = evt.sub;           // "v" or "note"
          const val = evt.val;

          // Local optimistic update
          setAnswers(s => {
            const existing = s[k] || {};
            return { ...s, [k]: { ...existing, [sub]: val } };
          });

          // Remote field-level update (only the one subfield)
          if (liveSessionId && !remoteApplyingRef.current) {
            debouncedPush.current && debouncedPush.current({
              answersPath: { [`${k}.${sub}`]: val }
            });
            if (evt.typing) setTypingState(k, sub, true);
          }

        } else if (evt.type === 'typing') {
          if (liveSessionId) setTypingState(evt.key, evt.sub, evt.on);

        } else if (evt.type === 'meta') {
          const patch = evt.patch || {};
          // Local optimistic
          setMeta(m => ({ ...m, ...patch }));
          // Remote
          if (liveSessionId && !remoteApplyingRef.current) {
            debouncedPush.current && debouncedPush.current({ meta: patch });
          }
        }
      }

      function onMetaChange(nextMeta){
        if(liveSessionId && !remoteApplyingRef.current){
          debouncedPush.current && debouncedPush.current({ meta: nextMeta });
        }
      }

      // Typing state in presence doc
      async function setTypingState(key, sub, on){
        clearTimeout(typingTimer.current);
        try{
          await db().collection(PRESENCE_COLL).doc(safeId(userEmailLower)).set({
            typingKey: on ? key : null,
            typingSub: on ? sub : null,
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }catch(e){}
        if (on) {
          typingTimer.current = setTimeout(()=>setTypingState(key, sub, false), TYPING_IDLE_MS);
        }
      }

      // ----- Invite flow -----
      async function sendCloudInvite(){
        const to = String(inviteEmail||"").trim().toLowerCase();
        if(!to){ alert("Enter recipient email"); return; }
        if(to===userEmailLower){ alert("You cannot invite yourself."); return; }
        if(!(await isAllowlisted(to))){ alert("Recipient email is not registered/allowlisted."); return; }

        try{
          const assessRef = await db().collection(ASSESS_COLL).add({
            version: VERSION,
            owner: userEmailLower,
            participants: [userEmailLower],
            meta, answers,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastWriter: userEmailLower
          });
          await db().collection(INVITES_COLL).add({
            sender: userEmailLower,
            recipient: to,
            status: 'pending',
            assessmentId: assessRef.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          setInviteEmail("");
          setLiveSessionId(assessRef.id);
          await attachLiveSession(assessRef.id);
          try { localStorage.setItem(SESSION_KEY, assessRef.id); } catch {}
          alert("Invite sent. Live session started.");
        }catch(e){
          console.warn(e);
          alert("Failed to send invite. Check connection/permissions.");
        }
      }

      async function withdrawInvite(id){
        try{
          await db().collection(INVITES_COLL).doc(id).update({ status: 'withdrawn' });
        }catch(e){ console.warn(e); alert("Could not withdraw invite."); }
      }

      async function acceptInvite(inv){
        try{
          if(!inv.assessmentId){ alert("Invalid invite (no session)."); return; }
          await db().collection(INVITES_COLL).doc(inv.id).update({
            status: 'accepted',
            acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await db().collection(ASSESS_COLL).doc(inv.assessmentId).set({
            participants: firebase.firestore.FieldValue.arrayUnion(userEmailLower),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastWriter: userEmailLower
          }, { merge: true });
          setLiveSessionId(inv.assessmentId);
          await attachLiveSession(inv.assessmentId);
          try { localStorage.setItem(SESSION_KEY, inv.assessmentId); } catch {}
          setShowTeam(false);
          alert("Joined live session.");
        }catch(e){ console.warn(e); alert("Failed to accept invite."); }
      }

      // ----- New assessment / Leave session -----
      async function newAssessment(){
        if(!confirm('This starts a new assessment and will CLEAR all fields. Continue?')) return;
        await detachLiveSession(true);
        const freshMeta = {hospital:'',address:"",visitDates:"",assessor:"", assessors:[{name:"", role:""}]};
        setMeta(freshMeta);
        setAnswers({});
        try { localStorage.removeItem(storageKey); } catch {}
      }
      async function leaveLiveSession(){
        if(!liveSessionId){ return; }
        await detachLiveSession(true);
      }

      // ----- Export helpers -----
      const nonCompliances = useMemo(()=>{
        const out=[]; 
        for(const s of [...SECTIONS, ...ANNEXURE_SECTIONS]){
          for(const it of s.items){
            const k=s.code + '-' + it.id; 
            if(answers[k]?.v==="No") out.push({section:s.code + ". " + s.title,item:it.text,note:answers[k]?.note||''}); 
          }
        } 
        return out;
      },[answers]);

      const fullRootRef = useRef(null);
      const nonRootRef  = useRef(null);
      useEffect(()=>{
        fullRootRef.current = ReactDOM.createRoot(document.getElementById('sheet-full'));
        nonRootRef.current  = ReactDOM.createRoot(document.getElementById('sheet-noncomp'));
        return ()=>{ try{ fullRootRef.current?.unmount(); }catch{} try{ nonRootRef.current?.unmount(); }catch{} };
      },[]);

      function exportFull(){
        const mount = document.getElementById('sheet-full');
        fullRootRef.current.render(<FullReport meta={meta} answers={answers} />);
        setTimeout(()=>{ const html = mount.innerHTML; fullRootRef.current.render(null); openPrintWindow(html); }, 40);
      }
      function exportNonComp(){
        const mount = document.getElementById('sheet-noncomp');
        nonRootRef.current.render(<NonCompReport meta={meta} answers={answers} />);
        setTimeout(()=>{ const html = mount.innerHTML; nonRootRef.current.render(null); openPrintWindow(html); }, 40);
      }

      // Buttons
      const btnBase = "rounded-xl border border-slate-200 bg-white text-slate-800 text-[13px] font-medium h-12 flex items-center justify-center shadow-sm active:scale-[0.99]";
      const btnDark = "rounded-xl bg-slate-900 text-white text-[13px] font-medium h-12 flex items-center justify-center shadow";
      const btnGreen= "rounded-xl bg-teal-600 text-white text-[13px] font-medium h-12 flex items-center justify-center shadow";
      const btnRose = "rounded-xl bg-rose-50 text-rose-700 border border-rose-200 text-[13px] font-medium h-12 flex items-center justify-center";

      const onlineNow = [...new Set(liveParticipants)].filter(Boolean);

      return (
        <>
          <HeaderBar email={userEmail} tab={tab} onTab={setTab} onSignOut={()=>auth().signOut()} />

          <main className="max-w-6xl mx-auto px-4 py-6">
            {/* Toolbar */}
            <div className="mb-3 bg-white border border-slate-200 rounded-2xl shadow-sm p-3">
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                <button onClick={exportFull} className={btnDark}>Export Full Report</button>
                <button onClick={exportNonComp} className={btnGreen}>Export Non-Compliances</button>

                <button onClick={saveLocal} className={btnBase}>Save As (Local)</button>
                <label className={btnBase + ' cursor-pointer'}>
                  Load from Fileâ€¦
                  <input type="file" accept="application/json" onChange={loadLocal} className="hidden" />
                </label>

                <button onClick={newAssessment} className={btnRose}>New assessment</button>
                <button onClick={()=>setShowTeam(true)} className={btnBase}>Work as a team</button>
              </div>

              <div className="flex flex-col md:flex-row md:items-center md:justify-between mt-2 gap-2">
                <div className="text-xs text-slate-500">Last edited: <span className="font-medium text-slate-700">{lastEdited||'-'}</span></div>

                {liveSessionId && (
                  <div className="flex items-center gap-2">
                    {/* Presence dots */}
                    <div className="flex -space-x-2">
                      {onlineNow.map(e=>(
                        <div key={e} className="relative w-7 h-7 rounded-full bg-teal-600 text-white grid place-items-center text-xs ring-2 ring-white">
                          {initials(e)}
                          <span className="absolute -bottom-0.5 -right-0.5 w-2 h-2 rounded-full bg-emerald-400 ring-2 ring-white"></span>
                        </div>
                      ))}
                    </div>
                    <div className="text-xs text-slate-600">
                      Live: {onlineNow.length ? onlineNow.join(", ") : "â€¦"}
                      {whoTypingTop.length ? <span className="ml-2 text-slate-500">({[...new Set(whoTypingTop)].map(x=>x.split('@')[0]).join(', ')} typingâ€¦)</span> : null}
                    </div>
                    <button onClick={leaveLiveSession} className="ml-2 rounded-full bg-white border px-3 py-1 text-xs text-slate-700">Leave</button>
                  </div>
                )}
              </div>
            </div>

            <HeaderFields value={meta} onChange={setMeta} onMetaChange={(m)=>onFieldChange({type:'meta', patch:m})} />

            <div className="space-y-6 mt-6">
              {(tab==="Checklist"?SECTIONS:ANNEXURE_SECTIONS.filter(x=>x.code===tab)).map(s => (
                <SectionCard key={s.code} section={s} state={answers} setState={setAnswers} onFieldChange={onFieldChange} typingMap={typingMap}/>
              ))}
            </div>

            <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm mt-6">
              <h3 className="font-semibold text-slate-900 mb-3">Non-Compliance Summary (live)</h3>
              {nonCompliances.length ? (
                <ul className="list-disc pl-6 text-sm text-slate-700 space-y-1">
                  {nonCompliances.map((r,i)=>(<li key={i}>{r.section}: {r.item}{r.note?' â€” '+r.note:''}</li>))}
                </ul>
              ) : (
                <div className="text-sm text-slate-500">No items marked as <span className="font-medium text-slate-700">No</span>.</div>
              )}
            </div>
          </main>

          {/* Team Modal */}
          {showTeam && (
            <div className="fixed inset-0 z-40">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setShowTeam(false)}></div>
              <div className="absolute inset-0 flex items-center justify-center p-4">
                <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                  <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                    <div className="font-semibold text-slate-900">Work as a team</div>
                    <button onClick={()=>setShowTeam(false)} className="rounded-md border bg-white px-2 py-1 text-slate-700">Ã—</button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-0">
                    {/* Send Collaboration */}
                    <div className="p-4 border-r border-slate-200">
                      <div className="font-medium mb-2">Send Collaboration</div>
                      <label className="block text-sm text-slate-600 mb-1">Registered Email</label>
                      <input value={inviteEmail} onChange={e=>setInviteEmail(e.target.value)} placeholder="teammate@example.com" className="w-full rounded-xl border px-3 py-2 mb-3" />
                      <button onClick={sendCloudInvite} className="rounded-lg bg-teal-600 text-white px-3 py-2">Invite</button>

                      <div className="mt-4">
                        <div className="text-sm font-medium text-slate-700 mb-2">Your pending invites</div>
                        {outgoingInvites.length ? (
                          <ul className="space-y-2">
                            {outgoingInvites.map(inv=>(
                              <li key={inv.id} className="flex items-center justify-between rounded-lg border border-slate-200 p-2">
                                <div className="text-sm">
                                  To <span className="font-medium">{inv.recipient}</span>
                                  {inv.assessmentId ? <span className="text-slate-500"> â€” session {inv.assessmentId.slice(0,6)}</span> : null}
                                </div>
                                <button onClick={()=>withdrawInvite(inv.id)} className="rounded-md border bg-white px-2 py-1 text-slate-700" title="Withdraw">Ã—</button>
                              </li>
                            ))}
                          </ul>
                        ) : <div className="text-xs text-slate-500">No pending invites.</div>}
                      </div>
                    </div>

                    {/* Accept Collaboration */}
                    <div className="p-4">
                      <div className="font-medium mb-2">Accept Collaboration</div>
                      <div className="text-sm text-slate-600 mb-2">Invites sent to you ({userEmailLower || "-"})</div>
                      {incomingInvites.length ? (
                        <ul className="space-y-2">
                          {incomingInvites.map(inv=>(
                            <li key={inv.id} className="rounded-lg border border-slate-200 p-2">
                              <div className="text-sm">
                                From <span className="font-medium">{inv.sender}</span>
                                {inv.assessmentId ? <span className="text-slate-500"> â€” session {inv.assessmentId.slice(0,6)}</span> : null}
                              </div>
                              <div className="mt-2 flex gap-2">
                                <button onClick={()=>acceptInvite(inv)} className="rounded-lg bg-teal-600 text-white px-3 py-1.5 text-sm">Accept & Join</button>
                              </div>
                            </li>
                          ))}
                        </ul>
                      ) : <div className="text-xs text-slate-500">No active invites.</div>}
                    </div>
                  </div>

                  <div className="p-3 border-t border-slate-200 text-right">
                    <button onClick={()=>setShowTeam(false)} className="rounded-lg border bg-white px-3 py-2 text-slate-700">Close</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <footer className="text-xs text-center py-4 border-t">Â© Kerala State Council for Clinical Establishments (KSCCE). Designed by Dr. Nitin.</footer>
        </>
      );
    }
    // ---------- Auth screens ----------
    function AuthScreen(){
      const [tab, setTab] = useState("login");
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [name, setName] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      async function handleLogin(e){
        e?.preventDefault(); setLoading(true); setError(null);
        try {
          if(!(await isAllowlisted(email))) throw new Error("This email is not allowlisted.");
          await auth().signInWithEmailAndPassword(email, password);
        } catch(err){
          setError(err.message||String(err));
        } finally { setLoading(false); }
      }
      async function handleSignup(e){
        e?.preventDefault(); setLoading(true); setError(null);
        try {
          if(!(await isAllowlisted(email))) throw new Error("This email is not allowlisted.");
          const cred=await auth().createUserWithEmailAndPassword(email, password);
          if(name&&cred.user) await cred.user.updateProfile({displayName:name});
        } catch(err){
          setError(err.message||String(err));
        } finally { setLoading(false); }
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex items-center justify-center p-4">
          <div className="w-full max-w-md">
            <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
              <div className="px-6 pt-6 pb-2">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 rounded-xl bg-teal-600 text-white grid place-items-center font-bold">KS</div>
                  <div>
                    <div className="font-semibold text-slate-900">KSCCE Hospital Checklist</div>
                    <div className="text-xs text-slate-500 leading-tight">Assessor Portal</div>
                  </div>
                </div>
                <div className="inline-flex rounded-lg bg-slate-100 p-1">
                  <button onClick={()=>setTab("login")} className={`px-3 py-1.5 rounded-md text-sm ${tab==="login"?"bg-white shadow border border-slate-200":"text-slate-600"}`}>Login</button>
                  <button onClick={()=>setTab("signup")} className={`px-3 py-1.5 rounded-md text-sm ${tab==="signup"?"bg-white shadow border border-slate-200":"text-slate-600"}`}>Create account</button>
                </div>
              </div>
              <form onSubmit={tab==="login"?handleLogin:handleSignup} className="px-6 pb-6 space-y-4">
                {tab==="signup" && (
                  <div>
                    <label className="block text-sm text-slate-600 mb-1">Full name</label>
                    <input value={name} onChange={e=>setName(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="Your name"/>
                  </div>
                )}
                <div>
                  <label className="block text-sm text-slate-600 mb-1">Email</label>
                  <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="you@example.com" required/>
                </div>
                <div>
                  <label className="block text-sm text-slate-600 mb-1">Password</label>
                  <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minLength={6} required/>
                </div>
                {error && <div className="text-sm text-rose-600">{error}</div>}
                <button type="submit" disabled={loading} className="w-full rounded-xl bg-teal-600 text-white py-2 font-medium shadow hover:bg-teal-700 disabled:opacity-60">
                  {loading ? "Please waitâ€¦" : (tab==="login"?"Login":"Create account")}
                </button>
                <p className="text-[11px] text-slate-500 leading-tight mt-1">Access is restricted. Only emails present in the allowlist can log in or create accounts.</p>
              </form>
            </div>
            <div className="text-center text-xs text-slate-500 mt-3">Â© Kerala State Council for Clinical Establishments (KSCCE). Designed by Dr. Nitin.</div>
          </div>
        </div>
      );
    }

    function App(){
      const [state, setState] = useState({ loading: true, user: null, allowed: false });
      useEffect(()=>{
        return auth().onAuthStateChanged(async (user) => {
          if (!user) {
            setState({ loading: false, user: null, allowed: false });
          } else {
            const ok = await isAllowlisted(user.email || "");
            if (!ok) { try { await auth().signOut(); } catch {} setState({ loading: false, user: null, allowed: false }); }
            else { setState({ loading: false, user, allowed: true }); }

          }
        });
      },[]);

      if (state.loading) return <div className="min-h-screen grid place-items-center bg-slate-50"><div className="text-slate-500">Loadingâ€¦</div></div>;
      if (!state.user || !state.allowed) return <AuthScreen />;
      return <ChecklistApp userEmail={state.user.email} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>