<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSCCE Assessments Portal v2.4</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --sticky-offset: 120px; }
    .screen-only { display: block; }
    .print-only { display: none; }
    @media print {
      .screen-only { display: none !important; }
      .print-only { display: none; }
      body.print-full #sheet-full.print-only { display: block !important; }
      body.print-noncomp #sheet-noncomp.print-only { display: block !important; }
      body { background: #fff !important; }
    }
    .section-body { padding-top: 1.25rem; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="screen-only"></div>
  <div id="print-mount">
    <div id="sheet-full" class="print-only"></div>
    <div id="sheet-noncomp" class="print-only"></div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Firebase init (Allowlist enforced)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDKSvo5KNuXPq83284_6GOnxXisKA_lSks",
      authDomain: "kssce-51e3e.firebaseapp.com",
      projectId: "kssce-51e3e",
      storageBucket: "kssce-51e3e.appspot.com",
      messagingSenderId: "308291560377",
      appId: "1:308291560377:web:ae634dd42e9ac1459e0c68"
    };
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const auth = () => firebase.auth();
    const db = () => firebase.firestore();

    async function isAllowlisted(email) {
      if (!email) return false;
      try {
        const doc = await db().doc(`allowlist/${String(email).trim().toLowerCase()}`).get();
        return doc.exists;
      } catch { return false; }
    }

    // Helper
    function nowStr(){ return new Date().toLocaleString(); }

    // ---------------- Auth Screen ----------------
    function AuthScreen(){
      const [tab,setTab]=useState("login");
      const [email,setEmail]=useState(""); const [password,setPassword]=useState("");
      const [name,setName]=useState(""); const [error,setError]=useState(null); const [loading,setLoading]=useState(false);

      async function handleLogin(e){ e?.preventDefault(); setLoading(true); setError(null);
        try{ if(!(await isAllowlisted(email))) throw new Error("Not allowlisted."); await auth().signInWithEmailAndPassword(email,password); }
        catch(err){ setError(err.message);} setLoading(false);
      }
      async function handleSignup(e){ e?.preventDefault(); setLoading(true); setError(null);
        try{ if(!(await isAllowlisted(email))) throw new Error("Not allowlisted."); await auth().createUserWithEmailAndPassword(email,password); if(name) await auth().currentUser.updateProfile({displayName:name}); }
        catch(err){ setError(err.message);} setLoading(false);
      }

      return (<div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-200 p-4">
        <div className="bg-white rounded-2xl shadow-lg w-full max-w-md p-6">
          <h1 className="font-bold text-slate-800 mb-4 text-lg">KSCCE Assessments Portal</h1>
          <div className="flex gap-2 mb-4">
            <button onClick={()=>setTab("login")} className={tab==="login"?"bg-teal-600 text-white px-3 py-1 rounded":"px-3 py-1"}>Login</button>
            <button onClick={()=>setTab("signup")} className={tab==="signup"?"bg-teal-600 text-white px-3 py-1 rounded":"px-3 py-1"}>Create Account</button>
          </div>
          <form onSubmit={tab==="login"?handleLogin:handleSignup} className="space-y-3">
            {tab==="signup" && (<input value={name} onChange={e=>setName(e.target.value)} placeholder="Full name" className="w-full border px-3 py-2 rounded"/>)}
            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full border px-3 py-2 rounded" required/>
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Password" className="w-full border px-3 py-2 rounded" required/>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button type="submit" disabled={loading} className="w-full bg-teal-600 text-white py-2 rounded">{loading?"Please wait…":(tab==="login"?"Login":"Sign up")}</button>
          </form>
        </div>
      </div>);
    }

    // ---------------- ChecklistApp ----------------
    function ChecklistApp({userEmail}){
      const [tab,setTab]=useState("Checklist");
      const [meta,setMeta]=useState({hospital:"",address:"",visitDates:"",assessor:""});
      const [answers,setAnswers]=useState({});
      const [lastEdited,setLastEdited]=useState("");

      // Save/Load Local
      const storageKey="kscce-v2.4-"+(userEmail||"local");
      useEffect(()=>{ const raw=localStorage.getItem(storageKey); if(raw){ try{const p=JSON.parse(raw); setMeta(p.meta||{}); setAnswers(p.answers||{});}catch{}}},[]);
      useEffect(()=>{ localStorage.setItem(storageKey,JSON.stringify({meta,answers})); setLastEdited(nowStr()); },[meta,answers]);

      function saveLocal(){
        const blob=new Blob([JSON.stringify({meta,answers},null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="assessment.json"; a.click(); URL.revokeObjectURL(a.href);
      }
      function loadLocal(e){ const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{try{const j=JSON.parse(r.result); setMeta(j.meta||{}); setAnswers(j.answers||{});}catch{}}; r.readAsText(f); e.target.value="";}
      function newAssessment(){ if(confirm("Start new assessment?")){setMeta({hospital:"",address:"",visitDates:"",assessor:""});setAnswers({});}}

      // Toolbar (scrollable)
      const toolbar=[
        {label:"Dashboard",disabled:true},
        {label:"New Assessment",action:newAssessment},
        {label:"Export Full Report",action:()=>alert("Full report export…")},
        {label:"Export Non-Compliances",action:()=>alert("Non-compliance export…")},
        {label:"Save As (Local)",action:saveLocal},
        {label:"Load from File",action:()=>document.getElementById("file-open").click()},
        {label:"Guidelines",disabled:true}
      ];

      return (<>
        <header className="sticky top-0 z-30 bg-white border-b px-4 py-2 flex justify-between">
          <h1 className="font-semibold text-slate-800">KSCCE Assessments Portal</h1>
          <button onClick={()=>auth().signOut()} className="px-3 py-1 bg-slate-100 rounded">Sign out</button>
        </header>

        <div className="overflow-x-auto whitespace-nowrap bg-white border-b px-2 py-2 flex gap-2">
          {toolbar.map((b,i)=>(<button key={i} onClick={b.action} disabled={b.disabled} className={"px-3 py-1 rounded border "+(b.disabled?"bg-slate-100 text-slate-400":"bg-teal-600 text-white")}>{b.label}</button>))}
        </div>
        <div className="text-xs text-slate-500 px-4">Last edited: {lastEdited}</div>

        <div className="overflow-x-auto whitespace-nowrap bg-slate-50 px-2 py-2 flex gap-2 sticky top-[48px] z-20">
          {["Checklist","Annexure 1","Annexure 2","Annexure 3","Annexure 4"].map(t=>(<button key={t} onClick={()=>setTab(t)} className={"px-3 py-1 rounded-full border "+(tab===t?"bg-teal-600 text-white":"bg-white")}>{t}</button>))}
        </div>

        <main className="p-4">
          <p className="text-slate-500">[Checklist/Annexure content goes here – aligned with official checklist in v2.1 export]</p>
          <input type="file" id="file-open" accept="application/json" onChange={loadLocal} className="hidden"/>
        </main>
        <footer className="text-xs text-center py-3 border-t">© KSCCE. Designed by Dr. Nitin.</footer>
      </>);
    }

    function App(){
      const [st,setSt]=useState({loading:true,user:null,allowed:false});
      useEffect(()=>auth().onAuthStateChanged(async u=>{
        if(!u){setSt({loading:false,user:null,allowed:false});}
        else{const ok=await isAllowlisted(u.email); if(!ok){await auth().signOut(); setSt({loading:false,user:null,allowed:false});} else{setSt({loading:false,user:u,allowed:true});}}
      }),[]);

      if(st.loading) return <div className="min-h-screen flex items-center justify-center">Loading…</div>;
      if(!st.user||!st.allowed) return <AuthScreen/>;
      return <ChecklistApp userEmail={st.user.email}/>;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>