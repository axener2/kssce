<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSCCE Hospital Checklist — v2.7</title>

  <!-- Tailwind (CDN is fine for GH Pages; can move to CLI later) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD + Babel for inline JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat (auth + allowlist read) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @media print {
      .screen-only { display: none !important; }
      body { background:#fff !important; }
    }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="screen-only"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const ReactDOMServer = window.ReactDOMServer;
    const VERSION = "v2.7";

    /* ---------------- Firebase (allowlist-only auth) ---------------- */
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDKSvo5KNuXPq83284_6GOnxXisKA_lSks",
      authDomain: "kssce-51e3e.firebaseapp.com",
      projectId: "kssce-51e3e",
      storageBucket: "kssce-51e3e.appspot.com",
      messagingSenderId: "308291560377",
      appId: "1:308291560377:web:ae634dd42e9ac1459e0c68"
    };
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const auth = () => firebase.auth();
    const db   = () => firebase.firestore();

    async function isAllowlisted(email){
      if (!email) return false;
      try {
        const ref = db().doc("allowlist/" + String(email).trim().toLowerCase());
        const snap = await ref.get();
        return snap.exists;
      } catch (e) {
        console.warn("Allowlist check failed:", e);
        return false;
      }
    }

    /* ---------------- Data (exact wordings retained) ---------------- */
    const YNN = ["Yes","No","N/A"];
    const SECTIONS = [
      { code: "A", title: "General", items: [
        { id:"ic-measures", text:"Hospital should adopt infection control measures." },
        { id:"bmw", text:"Appropriate arrangements for Bio-Medical Waste (BMW) management should be in place." },
        { id:"med-records", text:"Medical Records should be maintained by either in hard or soft copy." },
        { id:"lab-services", text:"Laboratory Services should be available. The same could be dedicated set up or a collection centre with appropriate arrangements for forwarding samples and specimens as well as effective deliverance of results." },
        { id:"birth-death", text:"Birth and death information register should be maintained." },
        { id:"power-backup", text:"Back up facility for electricity failure which covers essential activities should be available." },
        { id:"fire-ext", text:"Fire extinguishers should be available." },
        { id:"linen", text:"Facility for clean/ sterilized linens should be available." },
        { id:"ambulance", text:"Ambulance service arrangement should be in place." },
        { id:"display-services", text:"Display of Services provided and Rates & Packages." },
        { id:"charges-info", text:"Information regarding the services and their approximate charges should be provided by the administration of the hospital." },
      ]},
      { code: "B", title: "OPD", items: [
        { id:"opd-basics", text:"Availability of stethoscope, Torch, Thermometer (Preferably non-mercury), BP Apparatus (Preferably non-mercury), Hand wash facility, Examination table, chairs or stools for the doctor, patient and bystander." },
        { id:"female-attendant", text:"Female attendant for female patients, Privacy to Patients, Information Material for Patients." },
        { id:"registration", text:"Registration of Patients: Name, Age, Sex and contact details (at least mobile number) of the patient should be entered and available in hard or softcopy." },
        { id:"waiting-amenities", text:"Waiting Area, Drinking Water facility and separate male & female toilets should be available." },
        { id:"doc-display", text:"The names of the doctors with their qualifications should be displayed." },
      ]},
      { code: "C", title: "Casualty / Emergency", items: [
        { id:"cas-hr", text:"Human resources supporting the casualty services should be available during the working hours." },
        { id:"cas-drugs-eq", text:"Emergency drugs and equipments should be available according to the scope of the services." },
        { id:"cas-signage", text:"Signage board of the casualty should be displayed at the entrance and be easily visible." },
        { id:"ramp", text:"Patient friendly ramp or slope facility should be available." },
        { id:"stretchers", text:"Stretchers/wheel chairs should be available." },
      ]},
      { code: "D", title: "Inpatient (IPD)", items: [
        { id:"dept-signs", text:"Signboards of different departments and wards should be displayed." },
        { id:"on-call-doc", text:"A doctor should be available on call." },
        { id:"nursing-trained", text:"Personnel trained in nursing for at least 1 year should be available." },
        { id:"beds", text:"Beds should be made available to provide inpatient treatment." },
        { id:"call-system", text:"There should be a system to call the nurses and other attendants (Intercom/Call Bell)." },
        { id:"ipd-basics", text:"Hand Washing Facility/Hand Sanitizer, Bed pan, Waste bins, Attendants Chair/ Stool should be available." },
        { id:"ipd-amenities", text:"Drinking water facility and gender specific toilets should be available." },
      ]},
      { code: "E", title: "OP Cabin Registration Standards", items: [
        { id:"physician-display", text:"Name of the physician with qualification & Registration Number should be displayed." },
        { id:"op-equip", text:"Chairs/ Stool, Examination table, Torch, Thermometer (preferably non- mercurial), BP apparatus (preferably non-mercurial), Stethoscope should be available." },
        { id:"handwash-wait", text:"Hand washing facility, Drinking Water and waiting space should be present." },
      ]},
      { code: "F", title: "Laboratory Registration Standards", items: [
        { id:"lab-consultant", text:"Name of the Consultant with qualification and registration Number displayed." },
        { id:"lab-charges", text:"Display of services & Charges." },
        { id:"lab-equip", text:"Equipments and instruments as per the work load and scope of services." },
      ]},
      { code: "G", title: "Signage", items: [
        { id:"bi-lang", text:"Appropriate signage which shall be in at least two languages (English and Malayalam). A board stating ‘24 hours emergency available’ is desirable." },
        { id:"name-board", text:"Board displaying the name of the hospital at a prominent location." },
        { id:"provider-reg", text:"Name of the care provider with registration number." },
        { id:"reg-details", text:"Registration details of the hospital as applicable as per KCEA 2018." },
        { id:"fee-structure", text:"Availability of fee structure of the various services provided (as per KCEA 2018)." },
        { id:"timings", text:"Timings of the hospital and services provided." },
        { id:"mandatory-info", text:"Mandatory information such as under PNDT Act etc. displayed prominently as applicable." },
        { id:"important-contacts", text:"Important contact numbers such as Blood Banks, Fire Department, Police and Ambulance Services available in the nearby area." },
        { id:"hazard-signs", text:"Safety Hazard and Caution signs, e.g. hazards from electrical shock, inflammable articles, radiation etc. at appropriate places, and as applicable under law." },
        { id:"fire-exit", text:"Appropriate Fire exit signage." },
        { id:"no-smoking", text:"Signage for ‘No Smoking’ at prominent places." },
      ]},
      { code: "H", title: "Infrastructure – Other Requirements", items: [
        { id:"entry", text:"Convenient entry point to the hospital." },
        { id:"pwd", text:"Access within the requirements of ‘Persons with Disabilities Act’ and for all those whose mobility may be restricted due to whatever cause." },
        { id:"hygiene", text:"Safe, clean and hygienic environment for patients, their attendants, staff and visitors." },
        { id:"water-power", text:"24 hour provision of potable water for drinking & hand hygiene, 24 hour supply of electricity, either through direct supply or from other sources like UPS back up, generator facility etc." },
        { id:"public-toilets", text:"Clean public toilet(s) separate for males and females and disabled friendly." },
        { id:"furniture", text:"Furniture and fixtures shall be available in accordance with the activities and workload of the hospital. They shall be functional and properly maintained. Indicative list of furniture and fixtures is as per Annexure 1." },
      ]},
      { code: "I", title: "Infrastructure – Space Requirements", items: [
        { id:"waiting-100", text:"Reception & Waiting area – 100 sq. ft" },
        { id:"consult-80", text:"Consultation cabin with Physical Examination table – 80 sq. ft each" },
        { id:"pharmacy-40", text:"Storage & Pharmacy – 40 sq. ft" },
        { id:"ancillary-60", text:"Ancillary Area – 60 sq. ft" },
        { id:"ward-circ", text:"Circulation space of 30% shall be provided for Nursing station, Ward store, Sanitary etc." },
        { id:"ot-recep", text:"OT (Minor): Reception & Waiting area - 9.2 sq. mt" },
        { id:"ot-consult", text:"OT (Minor): Consultation cabin with Physical Examination table - 7.4 sq. mt each; examination area 3.71 sq. mt" },
        { id:"ot-ancillary", text:"OT (Minor): Storage & Pharmacy / Ancillary Area - 5.57 sq. mt" },
        { id:"ward-areas", text:"The ward shall also have designated areas for nursing station, doctors’ duty room, store, clean and dirty utility, janitor room, toilets and this shall be provided from circulation area." },
        { id:"ward-basin", text:"For a general ward of 20 beds, a minimum of 1 working counter and 1 hand wash basin shall be provided." },
        { id:"bed-gap", text:"Distance between beds shall be 1.0 metres (Desirable)." },
        { id:"head-space", text:"Space at the head end of bed shall be 0.25 metres." },
        { id:"door-corr", text:"Door width shall be 1.2 metres (Desirable) and corridor width 2.5 metres (Desirable)." },
      ]},
      { code: "J", title: "Medical Equipment & Instruments", items: [
        { id:"adequate-equip", text:"Adequate medical equipments and instruments, commensurate to the scope of service and number of beds." },
        { id:"maint-sys", text:"There shall be established system for maintenance of critical equipment." },
        { id:"amc", text:"Equipment shall be kept in good working condition through periodic inspection, cleaning and maintenance (AMC)." },
      ]},
      { code: "K", title: "Drugs, Medical Devices & Consumables", items: [
        { id:"adequate-drugs", text:"Adequate drugs, medical devices and consumables." },
        { id:"emg-drugs", text:"Emergency drugs and consumables shall be available at all times." },
        { id:"drug-storage", text:"Drug storage shall be in a clean, well lit, and safe environment and shall be in consonance with applicable laws and regulations." },
        { id:"inventory", text:"The facility shall have defined procedures for storage, inventory management and dispensing of drugs in pharmacy and patient care areas." },
      ]},
      { code: "L", title: "Human Resources", items: [
        { id:"nursing-hr", text:"Qualified and/or trained nursing staff as per the scope of service provided; nursing care as per professional and regulatory requirements." },
        { id:"paramed-hr", text:"Qualified and/or trained paramedical staff as per the scope of service provided; medical care as per professional and regulatory requirements." },
        { id:"staff-records", text:"For every staff (including contractual staff), there shall be personal record containing appointment order, documentary evidence of qualification and/or training (and professional registration where applicable)." },
        { id:"mbbs-req", text:"Qualified doctor shall be available during the working hours. MBBS Doctor required round the clock only if inpatient services are provided. Advanced primary care: MBBS doctor with post-graduation; Specialized Doctor on call." },
        { id:"nurse-exp", text:"Trained Nurses with ≥1 year experience — at least 1 in a hospital." },
        { id:"pharmacist", text:"Pharmacist (if in-house pharmacy available) — at least 1." },
        { id:"lab-tech", text:"Lab Technician (if in-house laboratory service available) — at least 1." },
        { id:"xray-tech", text:"X-ray Technician (if in-house X-ray facility available) — at least 1." },
        { id:"mts", text:"Multi Task staff — minimum 1." },
      ]},
      { code: "M", title: "Support Services", items: [
        { id:"reg-billing", text:"Have a Registration/ Help-desk & Billing counter." },
        { id:"diag", text:"Diagnostic services may be in-house or outsourced as per minimum standards for diagnostic services." },
        { id:"pharmacy", text:"Pharmacy services available, in-house or outsourced." },
      ]},
      { code: "N", title: "Waste Management Services", items: [
        { id:"general-waste", text:"Segregation, collection, transportation, storage and disposal of general waste as per applicable local laws." },
        { id:"bmw-rules", text:"Segregation, collection, transportation, storage and disposal of biomedical waste as per Bio Medical Waste Handling Rules." },
      ]},
      { code: "O", title: "Legal / Statutory", items: [
        { id:"local-law", text:"Compliance with local regulations and law." },
        { id:"ce-reg", text:"Clinical Establishments Registration (if applicable)." },
        { id:"pcb-bmw", text:"Bio-medical Waste Management Licenses from PCB." },
        { id:"other-lic", text:"Mandatory Licenses from concerned authorities as per the scope of services." },
      ]},
      { code: "P", title: "Records & Reporting", items: [
        { id:"min-records", text:"The minimum medical records to be maintained shall be as per Annexure 4 and as per KCEA 2018." },
        { id:"record-format", text:"Medical Records shall be maintained in physical or digital format." },
        { id:"ipd-records", text:"The medical records of IPD patients shall be maintained in consonance with National or local law, MCI guidelines, and court orders." },
      ]},
    ];

    const ANNEXURES = [
      { code:"Annexure 1", items:[
        "Examination Table","Writing tables","Chairs","Almirah","Waiting Benches","Inpatient Beds","Labour Table- if applicable","Wheel Chair/Stretcher","Medicine Trolley, Instrument Trolley","Screens/curtains","Foot Step","Bed Side Table","Baby Cot- if applicable","Stool","Medicine Chest","Examination Lamp","View box","Fans","Tube Light/ lighting fixtures","Wash Basin","IV Stand","Color coded bins for BMW"
      ].map((x,i)=>({id:"a1-"+i,text:x})) },
      { code:"Annexure 2", items:[
        "Stethoscope","Thermometer Digital","Torch (flash lights)","Sphygmomanometer (B. P. Apparatus) Digital","Weighing Machine Adult/Pediatric","Glucometer","Pulse Oximeter","Syringe & Needles Different size","Examination gloves","Examination table","Otoscope","Patellar hammer","Receptacle for soiled pads, dressings, etc","Sterile equipment storage","Sutures","Thermometer (Non mercury)","Dressing trolley","IV stands","Medicine storage cabinet","Oxygen cylinder","Suction machine","Urinals and bedpans","Linens"
      ].map((x,i)=>({id:"a2-"+i,text:x})) },
      { code:"Annexure 3", items:[
        "INJ. DIAZEPAM 10MG","INJ. FRUSEMIDE 20MG","INJ. ONDANSETRON 8MG/4ML","INJ. RANITIDINE","INJ. NOR ADRENALINE 4MG","INJ. PHENYTOIN 50MG","INJ. DICLOFENAC 75MG","INJ. DERIPHYLLINE","INJ. CHLORPHENIRAMINEMALEATE","INJ. HYDROCORTISONE 100MG","INJ. ATROPINE 0.6MG","INJ. ADRENALINE 1MG","INJ. KCL","STERILE WATER","INJ. SODABICARBONATE","INJ. DOPAMINE","INJ. NALAXONE 400MCG","INJ. LIGNOCAINE 50ML","TAB. SORBITRATE","TAB. ASPIRIN","INJ. TETANUS TOXOID","NEB. SALBUTAMOL 2.5ML","NEB. BUDESONIDE","LIGNOCAINE JELLY 2%","CALCIUM (INJ or TAB)","RL 500ML","NS 500ML","NS 250ML","NS 100ML","DNS 500ML","DEXTROSE 5% 500ML","DEXTROSE 10% 500ML","PEDIATRIC IV INFUSION SOLUTION 500ML"
      ].map((x,i)=>({id:"a3-"+i,text:x})) },
      { code:"Annexure 4", items:[
        "Name & Registration number of treating doctor","Name, demographic details & contact number of patient","Relevant Clinical history, Assessment and re-assessment findings, nursing notes and Diagnosis","Investigation reports","Details of medical treatment, invasive procedures, surgery and other care provided","Applicable consents","Discharge summary","Cause-of-death certificate & Death Summary (where applicable)"
      ].map((x,i)=>({id:"a4-"+i,text:x})) },
    ];

    const nowStr = ()=>new Date().toLocaleString();

    /* ---------------- UI: Header ---------------- */
    function HeaderBar({ email, onSignOut, onProfile, tab, onTab, showTabsDesktop }) {
      const TABS = ["Checklist","Annexure 1","Annexure 2","Annexure 3","Annexure 4"];
      return (
        <header className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-teal-600 text-white grid place-items-center font-bold">KS</div>
            <div className="grow">
              <div className="font-semibold text-slate-900">KSCCE Hospital Checklist</div>
              <div className="text-xs text-slate-500 leading-tight">Logged in as {email}</div>
            </div>

            {/* Profile icon */}
            <button
              onClick={onProfile}
              title="Profile"
              aria-label="Profile"
              className="ml-2 w-9 h-9 rounded-full border border-slate-200 bg-white grid place-items-center text-slate-600 hover:bg-slate-50"
            >
              {/* simple person icon */}
              <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4">
                <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke="currentColor" strokeWidth="1.5" />
                <path d="M4 20a8 8 0 0 1 16 0" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
              </svg>
            </button>

            <button onClick={onSignOut} className="px-3 py-1.5 rounded-full text-sm border bg-white text-slate-700">Sign out</button>
          </div>

          {/* Desktop tabs in header */}
          {showTabsDesktop && (
            <div className="hidden md:block border-t border-slate-200">
              <div className="max-w-6xl mx-auto px-4 py-2">
                <div className="flex flex-wrap gap-2">
                  {TABS.map(t => (
                    <button key={t}
                      onClick={()=>onTab(t)}
                      className={`px-3 py-1.5 rounded-full text-sm border ${tab===t ? "bg-teal-600 text-white border-teal-700" : "bg-white text-slate-700 border-slate-200"}`}>
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
        </header>
      );
    }

    /* Mobile sticky tabs (hidden on Dashboard) */
    function SectionTabsMobile({ tab, onTab, show }) {
      if (!show) return null;
      const TABS = ["Checklist","Annexure 1","Annexure 2","Annexure 3","Annexure 4"];
      return (
        <div className="md:hidden border-b border-slate-200 bg-white sticky top-[64px] z-30">
          <div className="max-w-6xl mx-auto px-3 py-2">
            <div className="overflow-x-auto no-scrollbar whitespace-nowrap">
              <div className="inline-flex gap-2">
                {TABS.map(t => (
                  <button key={t}
                          onClick={()=>onTab(t)}
                          className={`px-3 py-1.5 rounded-full text-sm border flex-shrink-0 ${tab===t?"bg-teal-600 text-white border-teal-700":"bg-white text-slate-700 border-slate-200"}`}>
                    {t}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    /* Compact Action Panel (white buttons by default) */
    function ActionPanel({ onFull, onNon, onSave, onLoad, onNew, lastEdited, show }) {
      if (!show) return null;
      const btn = "w-full h-10 rounded-xl border text-sm font-medium bg-white text-slate-700 hover:bg-slate-50";
      return (
        <div className="max-w-6xl mx-auto px-4 mt-3">
          <div className="bg-white border border-slate-200 rounded-2xl shadow-sm p-3">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
              <button onClick={onNew} className={`${btn} border-rose-200 text-rose-700`}>New assessment</button>
              <button onClick={onFull} className={`${btn}`}>Export Full Report</button>
              <button onClick={onNon} className={`${btn}`}>Export Non-Compliances</button>
              <button onClick={onSave} className={`${btn}`}>Save As (Local)</button>
              <label className={`${btn} cursor-pointer grid place-items-center`}>
                <span>Load from File…</span>
                <input type="file" accept="application/json" onChange={onLoad} className="hidden"/>
              </label>
            </div>
            <div className="text-xs text-slate-500 mt-2">Last edited: <span className="font-medium text-slate-700">{lastEdited || "-"}</span></div>
          </div>
        </div>
      );
    }

    /* Header fields */
    function HeaderFields({ value, onChange }) {
      return (
        <div className="max-w-6xl mx-auto px-4 mt-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
            <div><label className="block text-sm text-slate-600 mb-1">Hospital Name</label>
              <input value={value.hospital||""} onChange={e=>onChange({...value,hospital:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Hospital name"/></div>
            <div><label className="block text-sm text-slate-600 mb-1">Address</label>
              <input value={value.address||""} onChange={e=>onChange({...value,address:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Address"/></div>
            <div><label className="block text-sm text-slate-600 mb-1">Date(s) of Visit</label>
              <input value={value.visitDates||""} onChange={e=>onChange({...value,visitDates:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="e.g., 15–16 Sep 2025"/></div>
            <div><label className="block text-sm text-slate-600 mb-1">Assessor Name</label>
              <input value={value.assessor||""} onChange={e=>onChange({...value,assessor:e.target.value})} className="w-full rounded-xl border px-3 py-2" placeholder="Assessor name"/></div>
          </div>
        </div>
      );
    }

    function SectionCard({ section, state, setState }) {
      return (
        <div className="max-w-6xl mx-auto px-4">
          <div className="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden mt-4">
            <div className="px-4 py-2.5 bg-slate-50 border-b border-slate-200">
              <div className="font-semibold text-slate-900">{section.code}. {section.title}</div>
            </div>
            <div className="divide-y">
              {section.items.map((it, idx) => {
                const key = section.code + "-" + it.id;
                const row = state[key] || { v:"", note:"" };
                return (
                  <div key={key} className="p-4 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                    <div className="md:col-span-7 text-slate-800">
                      <span className="text-slate-400 mr-2">{idx+1}.</span>{it.text}
                    </div>
                    <div className="md:col-span-2">
                      <select value={row.v} onChange={e=>setState(s=>({...s,[key]:{...s[key],v:e.target.value}}))} className="w-full rounded-xl border px-3 py-2">
                        <option value="">Select</option>
                        {YNN.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div className="md:col-span-3">
                      <input value={row.note||""} onChange={e=>setState(s=>({...s,[key]:{...s[key],note:e.target.value}}))} placeholder="Notes / remarks" className="w-full rounded-xl border px-3 py-2"/>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* Profile (Dashboard) view with 'Return to Home' */
    function DashCard({ title, children }) {
      const [open, setOpen] = useState(true);
      return (
        <div className="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
          <button onClick={()=>setOpen(!open)} className="w-full flex items-center justify-between px-4 py-3 bg-slate-50 border-b border-slate-200">
            <div className="font-semibold text-slate-900">{title}</div>
            <span className="text-slate-500 text-sm">{open? "Hide" : "Show"}</span>
          </button>
          {open && <div className="p-4">{children}</div>}
        </div>
      );
    }
    function ProfileView({ onHome }) {
      return (
        <div className="max-w-6xl mx-auto px-4 py-4 space-y-4">
          <div className="flex">
            <button onClick={onHome} className="px-3 py-2 rounded-xl border bg-white text-slate-700 text-sm hover:bg-slate-50">Return to Home</button>
          </div>
          <DashCard title="Welcome back">
            <p className="text-slate-700 text-sm">Your profile dashboard. When cloud features land, this will show assignments and status.</p>
          </DashCard>
          <DashCard title="Upcoming Assessments">
            <p className="text-sm text-slate-700">No upcoming items yet.</p>
          </DashCard>
          <DashCard title="Completed Assessments">
            <p className="text-sm text-slate-700">Nothing here yet.</p>
          </DashCard>
          <DashCard title="Help & Support">
            <p className="text-sm text-slate-700">For support, contact the KSCCE admin or your coordinator.</p>
          </DashCard>
        </div>
      );
    }

    /* ---------------- Export helpers (kept) ---------------- */
    function kscceHeaderHTML() {
      return `
        <div style="text-align:center;font-weight:700">KERALA STATE COUNCIL FOR CLINICAL ESTABLISHMENTS</div>
        <div style="font-size:12px;text-align:center;line-height:1.35;margin-top:4px">
          2nd Floor, Hostel Block of Kerala State Institute of Health and Family Welfare, Thycaud, Thiruvananthapuram -14<br/>
          Phone: 0471-2966523, e-mail: kscce2018@gmail.com<br/>
          Website: www.clinicalestablishments.kerala.gov.in
        </div>
        <div style="height:24px"></div>
      `;
    }
    function openPrint(htmlInner) {
      const css = `
        body{font-family:Arial,Helvetica,sans-serif;color:#0f172a;margin:0}
        .wrap{padding:18px 20px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #cbd5e1;padding:6px 8px;font-size:12px;vertical-align:top}
        thead th{background:#eef2f7}
        h1{margin:8px 0 6px 0}
      `;
      const w = window.open("", "_blank");
      if (!w) { alert("Popup blocked. Allow popups for this site."); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>KSCCE Export</title><style>${css}</style></head><body><div class="wrap">${htmlInner}</div></body></html>`);
      w.document.close();
      setTimeout(()=>{ w.focus(); w.print(); }, 150);
    }
    function buildFullReportHTML(meta, answers){
      let html = kscceHeaderHTML();
      html += `
        <h1>Checklist for Hospital</h1>
        <table>
          <tbody>
            <tr><td style="width:30%;font-weight:600">Name & Address of the Hospital:</td><td>${(meta.hospital||"") + (meta.address?.trim()?(", "+meta.address):"")}</td></tr>
            <tr><td style="font-weight:600">Date(s) of Visit:</td><td>${meta.visitDates||""}</td></tr>
          </tbody>
        </table>
      `;
      const blocks = [...SECTIONS, ...ANNEXURES.map(a=>({code:a.code,title:a.code,items:a.items}))];
      for (const s of blocks) {
        html += `
          <div style="margin-top:14px;break-inside:avoid">
            <div style="font-weight:700;margin:6px 0">${s.code}. ${s.title}</div>
            <table>
              <thead><tr>
                <th style="width:8%">Sl. No.</th>
                <th>Item</th>
                <th style="width:12%">Answer</th>
                <th style="width:30%">Notes</th>
              </tr></thead>
              <tbody>
        `;
        s.items.forEach((it,i)=>{
          const k = s.code + "-" + (it.id ?? i);
          const r = answers[k] || {};
          html += `<tr>
            <td>${i+1}</td>
            <td>${it.text}</td>
            <td>${r.v||""}</td>
            <td>${r.note||""}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      }
      return html;
    }
    function buildNonCompHTML(meta, answers){
      let rows = [];
      function addRows(code, title, items){
        items.forEach((it,i)=>{
          const k = code + "-" + (it.id ?? i);
          const ans = answers[k]?.v || "";
          if (ans === "No") rows.push({section:`${code}. ${title}`, item:it.text, note:answers[k]?.note||""});
        });
      }
      SECTIONS.forEach(s => addRows(s.code, s.title, s.items));
      ANNEXURES.forEach(a => addRows(a.code, a.code, a.items));

      let html = kscceHeaderHTML();
      html += `
        <h1>Non-Compliance Report — Checklist (Hospital)</h1>
        <table>
          <tbody>
            <tr><td style="width:30%;font-weight:600">Name & Address of the Hospital:</td><td>${(meta.hospital||"") + (meta.address?.trim()?(", "+meta.address):"")}</td></tr>
            <tr><td style="font-weight:600">Date(s) of Visit:</td><td>${meta.visitDates||""}</td></tr>
          </tbody>
        </table>
      `;
      if (rows.length) {
        html += `<table style="margin-top:8px"><thead><tr>
          <th style="width:25%">Section</th><th>Item</th><th style="width:35%">Notes / Corrective Action</th>
        </tr></thead><tbody>`;
        rows.forEach(r=>{
          html += `<tr><td>${r.section}</td><td>${r.item}</td><td>${r.note}</td></tr>`;
        });
        html += `</tbody></table>`;
      } else {
        html += `<div style="margin-top:8px">No items marked as "No".</div>`;
      }
      return html;
    }

    /* ---------------- Root App ---------------- */
    function AuthScreen(){
      const [tab,setTab]=useState("login");
      const [email,setEmail]=useState("");
      const [password,setPassword]=useState("");
      const [name,setName]=useState("");
      const [loading,setLoading]=useState(false);
      const [error,setError]=useState(null);

      async function login(e){
        e?.preventDefault(); setLoading(true); setError(null);
        try{
          if(!(await isAllowlisted(email))) throw new Error("This email is not allowlisted.");
          await auth().signInWithEmailAndPassword(email,password);
        }catch(err){ setError(err.message||String(err)); } finally{ setLoading(false); }
      }
      async function signup(e){
        e?.preventDefault(); setLoading(true); setError(null);
        try{
          if(!(await isAllowlisted(email))) throw new Error("This email is not allowlisted.");
          const cred=await auth().createUserWithEmailAndPassword(email,password);
          if(name && cred.user) await cred.user.updateProfile({displayName:name});
        }catch(err){ setError(err.message||String(err)); } finally{ setLoading(false); }
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex items-center justify-center p-4">
          <div className="w-full max-w-md">
            <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
              <div className="px-6 pt-6 pb-2">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 rounded-xl bg-teal-600 text-white grid place-items-center font-bold">KS</div>
                  <div>
                    <div className="font-semibold text-slate-900">KSCCE Hospital Checklist</div>
                    <div className="text-xs text-slate-500 leading-tight">Assessor Login</div>
                  </div>
                </div>
                <div className="inline-flex rounded-lg bg-slate-100 p-1">
                  <button onClick={()=>setTab("login")} className={`px-3 py-1.5 rounded-md text-sm ${tab==="login"?"bg-white shadow border border-slate-200":"text-slate-600"}`}>Login</button>
                  <button onClick={()=>setTab("signup")} className={`px-3 py-1.5 rounded-md text-sm ${tab==="signup"?"bg-white shadow border border-slate-200":"text-slate-600"}`}>Create account</button>
                </div>
              </div>
              <form onSubmit={tab==="login"?login:signup} className="px-6 pb-6 space-y-4">
                {tab==="signup" && (
                  <div>
                    <label className="block text-sm text-slate-600 mb-1">Full name</label>
                    <input value={name} onChange={e=>setName(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="Your name"/>
                  </div>
                )}
                <div>
                  <label className="block text-sm text-slate-600 mb-1">Email</label>
                  <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="you@example.com" required/>
                </div>
                <div>
                  <label className="block text-sm text-slate-600 mb-1">Password</label>
                  <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full rounded-xl border px-3 py-2" placeholder="••••••••" minLength={6} required/>
                </div>
                {error && <div className="text-sm text-rose-600">{error}</div>}
                <button type="submit" disabled={loading} className="w-full rounded-xl bg-teal-600 text-white py-2 font-medium shadow hover:bg-teal-700 disabled:opacity-60">
                  {loading ? "Please wait…" : (tab==="login"?"Login":"Create account")}
                </button>
                <p className="text-[11px] text-slate-500 leading-tight">Access is restricted. Only emails present in the allowlist can log in or create accounts.</p>
              </form>
            </div>
            <div className="text-center text-xs text-slate-500 mt-3">© Kerala State Council for Clinical Establishments (KSCCE). Designed by Dr. Nitin.</div>
          </div>
        </div>
      );
    }

    function ChecklistApp({ userEmail }) {
      const [view, setView] = useState("Assessment"); // "Assessment" | "Profile"
      const [tab, setTab] = useState("Checklist");
      const [meta, setMeta] = useState({ hospital:"", address:"", visitDates:"", assessor:"" });
      const [answers, setAnswers] = useState({});
      const [lastEdited, setLastEdited] = useState("");

      const storageKey = `kscce-${VERSION}-${userEmail||"local"}`;
      useEffect(() => {
        const raw = localStorage.getItem(storageKey);
        if (raw) { try { const p = JSON.parse(raw); setMeta(p.meta||{}); setAnswers(p.answers||{}); } catch {} }
      }, []);
      useEffect(() => {
        localStorage.setItem(storageKey, JSON.stringify({ meta, answers }));
        setLastEdited(nowStr());
      }, [meta, answers]);

      function saveLocal(){
        const blob = new Blob([JSON.stringify({version:VERSION, meta, answers}, null, 2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${(meta.hospital||"Hospital").replace(/\s+/g,'_')}-${new Date().toISOString().slice(0,10)}.json`;
        a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 250);
      }
      function loadLocal(e){
        const f = e.target.files?.[0]; if(!f) return;
        const r = new FileReader();
        r.onload = () => { try{ const j=JSON.parse(r.result); setMeta(j.meta||{}); setAnswers(j.answers||{}); } catch{ alert("Invalid JSON"); } };
        r.readAsText(f); e.target.value="";
      }
      function newAssessment(){
        if (confirm("Start a new assessment?")) {
          setMeta({ hospital:"", address:"", visitDates:"", assessor:"" });
          setAnswers({});
          setView("Assessment");
          setTab("Checklist");
        }
      }
      const exportFull = ()=>openPrint(buildFullReportHTML(meta, answers));
      const exportNon  = ()=>openPrint(buildNonCompHTML(meta, answers));

      const visibleSections =
        tab==="Checklist"
          ? SECTIONS
          : [{ code: tab, title: tab, items: (ANNEXURES.find(a=>a.code===tab)||{}).items || [] }];

      const nonCompliances = useMemo(()=>{
        const out = [];
        for(const s of SECTIONS){ for(const it of s.items){ const k=s.code+"-"+it.id; if(answers[k]?.v==="No") out.push({section:s.code+". "+s.title, item:it.text, note:answers[k]?.note||""}); } }
        for(const a of ANNEXURES){ for(const it of a.items){ const k=a.code+"-"+it.id; if(answers[k]?.v==="No") out.push({section:a.code, item:it.text, note:answers[k]?.note||""}); } }
        return out;
      }, [answers]);

      return (
        <>
          <HeaderBar
            email={userEmail}
            onSignOut={()=>auth().signOut()}
            onProfile={()=>setView("Profile")}
            tab={tab}
            onTab={setTab}
            showTabsDesktop={view==="Assessment"}
          />

          {/* Mobile sticky tabs only for Assessment view */}
          <SectionTabsMobile tab={tab} onTab={setTab} show={view==="Assessment"} />

          {/* Action panel hidden on Profile */}
          <ActionPanel
            show={view==="Assessment"}
            onNew={newAssessment}
            onFull={exportFull}
            onNon={exportNon}
            onSave={saveLocal}
            onLoad={loadLocal}
            lastEdited={lastEdited}
          />

          {view==="Profile" ? (
            <ProfileView onHome={()=>setView("Assessment")} />
          ) : (
            <main className="space-y-4 pb-6">
              <HeaderFields value={meta} onChange={setMeta} />
              {visibleSections.map(s => (
                <SectionCard key={s.code} section={s} state={answers} setState={setAnswers} />
              ))}

              <div className="max-w-6xl mx-auto px-4">
                <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm mt-6">
                  <h3 className="font-semibold text-slate-900 mb-3">Non-Compliance Summary (live)</h3>
                  {nonCompliances.length
                    ? <ul className="list-disc pl-6 text-sm text-slate-700 space-y-1">
                        {nonCompliances.map((r,i)=>(<li key={i}>{r.section}: {r.item}{r.note?` — ${r.note}`:""}</li>))}
                      </ul>
                    : <div className="text-sm text-slate-500">No items marked as <span className="font-medium text-slate-700">No</span>.</div>
                  }
                </div>
              </div>
            </main>
          )}

          <footer className="text-xs text-center py-4 border-t">
            © Kerala State Council for Clinical Establishments (KSCCE). Designed by Dr. Nitin.
          </footer>
        </>
      );
    }

    function App(){
      const [st, setSt] = useState({ loading:true, user:null, allowed:false });
      useEffect(()=>auth().onAuthStateChanged(async (user)=>{
        if (!user) {
          setSt({ loading:false, user:null, allowed:false });
        } else {
          const ok = await isAllowlisted(user.email||"");
          if (!ok) { try{ await auth().signOut(); }catch{} setSt({ loading:false, user:null, allowed:false }); }
          else { setSt({ loading:false, user, allowed:true }); }
        }
      }), []);

      if (st.loading) return <div className="min-h-screen grid place-items-center bg-slate-50"><div className="text-slate-500">Loading…</div></div>;
      if (!st.user || !st.allowed) return <AuthScreen />;
      return <ChecklistApp userEmail={st.user.email} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>